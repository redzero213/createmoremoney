<!DOCTYPE html>
<html lang="zh-HK" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e1e">
    <title>å›è´ˆå“¥ - æ™ºèƒ½ç°½è³¬ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #00d26a; --primary-dark: #00a855; --bg: #121212; --surface: #1e1e1e; --surface-hover: #2d2d2d; --text: #e0e0e0; --text-muted: #a0a0a0; --danger: #ff4d4d; --income: #4facfe; --repay: #ff9f43; --miles: #a29bfe; --mission: #f39c12; --welcome: #e84393; --sub: #e17055; --trade: #00cec9; --info: #0984e3; --telegram: #229ED9; --border: #333; --card-gradient: linear-gradient(135deg, #2c3e50, #000000); --shadow: 0 4px 6px rgba(0,0,0,0.3); }
        [data-theme="light"] { --primary: #00b85c; --primary-dark: #008f45; --bg: #f4f6f8; --surface: #ffffff; --surface-hover: #eef2f5; --text: #1a1a1a; --text-muted: #666666; --danger: #d93025; --income: #1a73e8; --repay: #e37400; --miles: #6c5ce7; --mission: #d35400; --welcome: #d63031; --sub: #d63031; --trade: #00b894; --info: #0984e3; --telegram: #229ED9; --border: #e0e0e0; --card-gradient: linear-gradient(135deg, #2c3e50, #4ca1af); --shadow: 0 2px 8px rgba(0,0,0,0.08); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        header { background: var(--surface); padding: 12px 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .app-logo { width: 28px; height: 28px; object-fit: contain; }
        .menu-btn { font-size: 0.9rem; background: var(--surface-hover); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .panel { background: var(--surface); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: var(--surface-hover); padding: 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: var(--text); margin: 5px 0; word-break: break-word; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); }
        .profit-pos { color: var(--primary); } .profit-neg { color: var(--danger); }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .menu-item { background: var(--surface-hover); border: 1px solid var(--border); border-radius: 12px; padding: 20px 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .menu-item:hover { border-color: var(--primary); }
        .menu-icon { font-size: 2rem; } .menu-label { font-size: 0.9rem; font-weight: bold; } .menu-desc { font-size: 0.75rem; color: var(--text-muted); }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .item-main { flex: 1; }
        .item-title { font-weight: 500; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .item-sub { font-size: 0.8rem; color: var(--text-muted); }
        .item-amount { font-weight: bold; font-size: 1.1rem; text-align: right; margin-left: 10px; }
        .item-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .cat-tag, .shop-tag, .source-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--surface-hover); border: 1px solid var(--border); color: var(--text-muted); }
        .shop-tag { background: var(--trade); color: #000; font-weight: bold; }
        .source-tag { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--text-muted); margin-right: 4px;}
        
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .status-ordered { background: #f39c12; color: #000; } 
        .status-stock { background: #3498db; color: #fff; } 
        .status-sold { background: var(--primary); color: #fff; } 
        .status-cut { background: var(--danger); color: #fff; text-decoration: line-through; } 

        .cashback-tag { font-size: 0.75rem; color: var(--primary); background: rgba(0, 210, 106, 0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .miles-tag { font-size: 0.75rem; color: var(--miles); background: rgba(162, 155, 254, 0.15); padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .due-tag { font-size: 0.7rem; color: var(--text-muted); display: block; margin-top: 2px; }
        .form-group { margin-bottom: 15px; } label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; outline: none; }
        .row-group { display: flex; gap: 10px; } .row-group > div { flex: 1; }
        .type-toggle { display: flex; background: var(--bg); border-radius: 8px; padding: 4px; border: 1px solid var(--border); margin-bottom: 15px; }
        .type-option { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        .type-option.active.expense { background: rgba(255, 77, 77, 0.15); color: var(--danger); }
        .type-option.active.income { background: rgba(79, 172, 254, 0.15); color: var(--income); }
        .type-option.active.repayment { background: rgba(255, 159, 67, 0.15); color: var(--repay); border: 1px solid var(--repay); }
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .grid-btn { padding: 5px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 0.8rem; text-align: center; display:flex; align-items:center; justify-content:center; flex-direction:column; min-height:55px; line-height: 1.2; overflow-wrap: break-word; -webkit-tap-highlight-color: transparent;}
        .grid-btn:active { background: var(--surface); transform: scale(0.98); }
        .grid-btn.selected { background: var(--trade); color: #000; border-color: var(--trade); font-weight: bold; }
        
        .analysis-controls { display: flex; gap: 5px; background: var(--bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; overflow-x: auto; }
        .analysis-btn { flex: 1; padding: 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 6px; font-size: 0.85rem; white-space: nowrap; }
        .analysis-btn.active { background: var(--surface-hover); color: var(--text); font-weight: bold; }
        .btn { background: var(--primary); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; border-radius: 6px; background: var(--surface-hover); color: var(--text); border: 1px solid var(--border); cursor: pointer; }
        .btn-text { background: none; border: none; color: var(--text-muted); padding: 5px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; }
        .btn-repay { color: var(--repay); border-color: var(--repay); background: rgba(255, 159, 67, 0.1); }
        .btn-telegram { background: var(--telegram); border-color: var(--telegram); color: #fff; }
        
        /* Credit Card Visual */
        .credit-card { background: var(--card-gradient); padding: 15px; border-radius: 10px; margin-bottom: 10px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); color: #fff; }
        .card-name { font-weight: bold; font-size: 1.1rem; color: #fff; }
        .card-info { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .fab { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: #fff; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,210,106,0.4); cursor: pointer; border: none; z-index: 90; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--surface); width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; padding: 25px; border-radius: 16px; padding-bottom: 50px; position: relative; }
        
        /* Improved Close Button */
        .close-modal { 
            position: absolute; top: 10px; right: 10px; 
            background: #cc4444; border: 2px solid #fff; color: #fff; 
            width: 36px; height: 36px; border-radius: 50%; 
            font-size: 1.4rem; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .close-modal:active { transform: scale(0.9); }
        
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; overflow-x: auto; white-space: nowrap; }
        .tab { flex: 1; padding: 10px; text-align: center; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; min-width: 80px; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 999; left: 50%; bottom: 80px; transform: translateX(-50%); border: 1px solid var(--primary); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 60px; opacity: 0;} }
        .checkbox-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); }
        .recur-item, .welcome-item { background: var(--surface-hover); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .recur-item.completed { border-color: var(--primary); background: rgba(0, 210, 106, 0.05); }
        .footer { text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 30px; padding-bottom: 20px; }
        .toggle-switch { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; margin-bottom: 10px; }
        .toggle-switch input { width: auto; margin: 0; }
        
        /* CSS Phone Icons */
        .phone-icon { width: 22px; height: 40px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); position: relative; margin-bottom: 3px; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .phone-icon::before { content: ''; position: absolute; top: 5px; left: 4px; width: 10px; height: 10px; background: rgba(0,0,0,0.4); border-radius: 3px; }
        .phone-icon.silver { background: linear-gradient(135deg, #e3e4e5 0%, #999 100%); }
        .phone-icon.orange { background: linear-gradient(135deg, #C5B4A3 0%, #8C7C6D 100%); }
        .phone-icon.blue { background: linear-gradient(135deg, #3B4C58 0%, #202b36 100%); }
        .section-title { font-size: 0.85rem; color: var(--text-muted); margin: 15px 0 5px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 2px; }
        
        .log-list { max-height: 300px; overflow-y: auto; text-align: left; }
        .log-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .log-date { font-size: 0.75rem; color: var(--primary); font-weight: bold; }
        .log-content { font-size: 0.85rem; color: var(--text); line-height: 1.4; white-space: pre-line; }
        
        #error-console { display:none; background:#300; color:#fff; padding:10px; font-size:0.8rem; position:fixed; bottom:0; left:0; right:0; z-index:1000; text-align:left; max-height:100px; overflow:auto; }
    </style>
</head>
<body>

<header>
    <h1>
        <img src="https://cdn-icons-png.flaticon.com/512/6963/6963703.png" alt="Logo" class="app-logo"> 
        å›è´ˆå“¥
    </h1>
    <div class="header-actions">
        <button class="menu-btn" onclick="openMenuTarget('menu')">â˜° é¸å–®</button>
    </div>
</header>

<div class="container">
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-size:0.9rem; color:var(--text-muted);">æœ¬æœˆæ¦‚è¦½ <span id="billing-cycle-text" style="font-size:0.75rem;"></span></div>
            <button class="btn-text" onclick="openMenuTarget('subs')" style="font-size:0.8rem;">ğŸ”„ å›ºå®šé–‹æ”¯</button>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">ç¸½æ”¯å‡º</div><div class="stat-value" id="total-spent" style="color:var(--danger)">$0</div></div>
            <div class="stat-card"><div class="stat-label">ç¸½æ”¶å…¥</div><div class="stat-value" id="total-income" style="color:var(--income)">$0</div></div>
            <div class="stat-card"><div class="stat-label">æœ¬æœˆå·²é‚„</div><div class="stat-value" id="total-repaid" style="color:var(--repay)">$0</div></div>
            <div class="stat-card"><div class="stat-label">å›è´ˆä¼°ç®—</div><div class="stat-value" id="total-cashback" style="color:var(--primary); font-size: 0.9rem;">$0</div></div>
        </div>
        <div id="missions-container"></div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('transactions')">è³¬ç›®ç´€éŒ„</div>
        <div class="tab" onclick="switchTab('cards')">å¡åŒ… / å¸³æˆ¶</div>
        <div class="tab" onclick="switchTab('trading')">ğŸ“± ç‚’è³£</div>
        <div class="tab" onclick="switchTab('analysis')">çµ±è¨ˆåˆ†æ</div>
    </div>

    <div id="tab-transactions" class="tab-content active">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">æœ€è¿‘è³¬ç›®</h2>
                <span class="stat-label" id="tx-count">0 ç­†</span>
            </div>
            <div id="transaction-list"></div>
        </div>
    </div>

    <div id="tab-cards" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">æˆ‘çš„å¡åŒ…</h2>
                <div style="display:flex; gap:8px;">
                     <button class="btn-small" onclick="importPresetCards()" style="background:rgba(0,210,106,0.1); border-color:var(--primary); color:var(--primary);">ğŸ“¥ åŒ¯å…¥é è¨­</button>
                    <button class="btn-small" onclick="openModal('card')">+ æ–°å¢</button>
                </div>
            </div>
            <div id="card-list"></div>
        </div>
    </div>

    <div id="tab-trading" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0; font-size:1.1rem;">ğŸ“± iPhone 17 ç‚’è³£ç´€éŒ„</h2>
                <div style="display:flex; gap:8px;">
                    <button class="btn-small" onclick="sendTradeReport()" style="background:var(--telegram); color:white;">ğŸ“Š å ±å‘Š</button>
                    <button class="btn-small" onclick="openModal('trade')" style="background:var(--trade); border-color:var(--trade); color:#000;">+ æ–°å¢äº¤æ˜“</button>
                </div>
            </div>
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-bottom:15px;">
                <div class="stat-card"><div class="stat-label">ä»Šæ—¥åˆ©æ½¤</div><div class="stat-value" id="trade-today-profit" style="color:var(--primary)">$0</div></div>
                <div class="stat-card"><div class="stat-label">ä»Šæ—¥è²¨é‡</div><div class="stat-value" id="trade-today-vol" style="color:var(--text)">0 éƒ¨</div></div>
            </div>
            <div id="trade-list"></div>
        </div>
    </div>

    <div id="tab-analysis" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">çµ±è¨ˆåˆ†æ</h2>
                 <button class="btn-small" onclick="sendTelegramReport()" style="background:var(--telegram); color:white;">âœˆï¸ æ¨é€</button>
            </div>
             
             <label class="toggle-switch">
                 <input type="checkbox" id="analysis-include-trade" onchange="renderCharts()">
                 <span>åŒ…å«ç‚’è³£æ•¸æ“š (Cost)</span>
             </label>

             <div class="analysis-controls">
                <button class="analysis-btn active" onclick="setAnalysisMode('month')" id="btn-mode-month">ğŸ“… å–®æœˆ</button>
                <button class="analysis-btn" onclick="setAnalysisMode('range')" id="btn-mode-range">ğŸ“† è‡ªè¨‚ç¯„åœ</button>
                <button class="analysis-btn" onclick="setAnalysisMode('compare')" id="btn-mode-compare">ğŸ†š æœˆåº¦æ¯”è¼ƒ</button>
            </div>
            <div id="analysis-inputs" style="margin-bottom:15px; display:flex; gap:10px; align-items:center;"></div>
            <div id="analysis-charts-container">
                <div style="margin-bottom:30px;"><div class="chart-container"><canvas id="chart-cards"></canvas></div></div>
                <div><div class="chart-container"><canvas id="chart-daily"></canvas></div></div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Copyright Â© Redezero | v1.69 <br>
        <button onclick="rescueData()" style="background:transparent; border:none; color:var(--text-muted); font-size:0.7rem;">â›‘ï¸ ä¸‹è¼‰å‚™ä»½</button>
    </div>
    
    <div id="error-console"></div>
</div>

<div id="main-fab"><button class="fab" onclick="openModal('transaction')">+</button></div>

<!-- Modals -->
<div id="modal-menu" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">Ã—</button>
        <h2>åŠŸèƒ½é¸å–®</h2>
        <div class="menu-grid">
            <div class="menu-item" onclick="openMenuTarget('mission')"><div class="menu-icon">â•</div><div class="menu-label">æ–°å¢é™æ™‚ä»»å‹™</div></div>
            <div class="menu-item" onclick="openMenuTarget('recur-mission')"><div class="menu-icon">ğŸ¯</div><div class="menu-label">æ¯æœˆä»»å‹™</div></div>
            <div class="menu-item" onclick="openMenuTarget('welcome')"><div class="menu-icon">ğŸ</div><div class="menu-label">è¿æ–°ç›£å¯Ÿ</div></div>
            <div class="menu-item" onclick="openMenuTarget('subs')"><div class="menu-icon">ğŸ”„</div><div class="menu-label">å›ºå®šé–‹æ”¯</div></div>
            <div class="menu-item" onclick="openMenuTarget('bank-info')"><div class="menu-icon">â„¹ï¸</div><div class="menu-label">éŠ€è¡Œè³‡è¨Š</div></div>
            <div class="menu-item" onclick="openMenuTarget('data')"><div class="menu-icon">â˜ï¸</div><div class="menu-label">å‚™ä»½èˆ‡åŒæ­¥</div></div>
            <div class="menu-item" onclick="openMenuTarget('settings')"><div class="menu-icon">âš™ï¸</div><div class="menu-label">è¨­å®š</div></div>
            <div class="menu-item" onclick="toggleTheme(); closeModals();"><div class="menu-icon">ğŸŒ—</div><div class="menu-label">åˆ‡æ›æ¨¡å¼</div></div>
        </div>
        <div style="margin-top:15px; text-align:center;">
            <button class="btn-text" onclick="openMenuTarget('log')">ğŸ“‹ æŸ¥çœ‹æ›´æ–°æ—¥èªŒ</button>
        </div>
    </div>
</div>

<div id="modal-transaction" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">Ã—</button>
        <h2 id="tx-modal-title">æ–°å¢ç´€éŒ„</h2>
        <div class="type-toggle">
            <div class="type-option active expense" id="type-expense" onclick="setTxType('expense')">ğŸ’¸ æ”¯å‡º</div>
            <div class="type-option" id="type-income" onclick="setTxType('income')">ğŸ’° æ”¶å…¥</div>
            <div class="type-option" id="type-repayment" onclick="setTxType('repayment')">ğŸ’³ é‚„æ¬¾</div>
        </div>
        <form id="tx-form" onsubmit="handleTransactionSubmit(event)">
            <input type="hidden" id="tx-type" value="expense">
            <input type="hidden" id="tx-id">
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;"><label>è²¨å¹£</label><select id="tx-currency" onchange="handleCurrencyChange()"></select></div>
                <div style="flex:1; display:none;" id="fx-rate-container"><label>åŒ¯ç‡</label><input type="number" id="tx-fx-rate" step="0.0001" oninput="calcHkdAmount()"></div>
            </div>
            <input type="checkbox" id="tx-is-foreign" style="display:none;">
            <div class="form-group" id="fx-amount-container" style="display:none;"><label>å¤–å¹£é‡‘é¡</label><input type="number" id="tx-fx-amount" step="0.01" oninput="calcHkdAmount()"></div>
            <div class="form-group"><label id="lbl-amount">é‡‘é¡ (HKD)</label><div style="display:flex; gap:10px;"><input type="number" id="tx-amount" step="0.1" required style="flex:1;"><button type="button" class="btn-small" onclick="openModal('split')">âœ‚ï¸</button></div></div>
            <div class="form-group" id="group-category"><label>é¡åˆ¥</label><select id="tx-category" required></select></div>
            <div class="form-group" id="group-card"><label>ä¿¡ç”¨å¡</label><select id="tx-card" onchange="updateCardHint()"></select><div id="card-hint" style="font-size:0.8rem; color:var(--primary); margin-top:5px; display:none;"></div></div>
            <div class="form-group"><label>æè¿°</label><input type="text" id="tx-desc" required></div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="datetime-local" id="tx-date" required></div>
            <div class="form-group"><input type="checkbox" id="tx-tg-auto" style="width:auto;"> <label for="tx-tg-auto" style="display:inline;">ç™¼é€ TG</label></div>
            <div style="display:flex; gap:10px;"><button type="submit" class="btn" id="btn-submit" style="flex:2;">è¨˜è³¬</button><button type="button" id="btn-transfer" class="btn" style="flex:1; background:var(--trade); color:#000; display:none;" onclick="transferToTrade()">ğŸ“± è½‰ç‚’è³£</button></div>
        </form>
    </div>
</div>

<div id="modal-trade" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">Ã—</button>
        <h2>ğŸ“± æ–°å¢ iPhone 17 äº¤æ˜“</h2>
        <form id="trade-form" onsubmit="addTrade(event)">
            <input type="hidden" id="trade-id">
            
            <div class="section-title">1. è¨‚å–®è³‡æ–™</div>
            <div class="row-group">
                 <div class="form-group">
                    <label>è³¼å…¥ä¾†æº</label>
                    <select id="trade-source" required></select>
                </div>
                <div class="form-group">
                    <label>è¨‚å–®ç·¨è™Ÿ (é¸å¡«)</label>
                    <input type="text" id="trade-oid" placeholder="ä¾‹å¦‚: W538...">
                </div>
            </div>
            
            <div class="section-title">2. äº¤æ˜“ç‹€æ…‹ (Status)</div>
            <div class="form-group">
                <div class="btn-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="grid-btn" onclick="selectTradeOption('status', 'pending', this)">ğŸ›’ å·²è¨‚<br>(æœªå–)</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'stock', this)">ğŸ“¦ ç¾è²¨<br>(åœ¨æ‰‹)</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'sold', this)">ğŸ’° å·²è³£<br>(å®Œæˆ)</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'cut', this)">âŒ Cutå–®<br>(ä½”é¡)</div>
                </div>
                <input type="hidden" id="trade-status" required>
            </div>

            <div class="section-title">3. å›æ”¶åº—èˆ– (å¦‚å·²è³£å‡º)</div>
            <div class="form-group">
                <select id="trade-shop">
                    <option value="">-- è«‹é¸æ“‡ (æœªè³£å‡ºå¯ä¸å¡«) --</option>
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div class="section-title">4. è¦æ ¼ & è²¡å‹™</div>
            <div class="form-group"><label>å‹è™Ÿ</label><div class="btn-grid" style="grid-template-columns: 1fr 1fr;"><div class="grid-btn" onclick="selectTradeOption('model', 'Pro', this)">Pro</div><div class="grid-btn" onclick="selectTradeOption('model', 'Pro Max', this)">Pro Max</div></div><input type="hidden" id="trade-model" required></div>
            <div class="form-group"><label>å®¹é‡</label><div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);"><div class="grid-btn" onclick="selectTradeOption('cap', '256GB', this)">256GB</div><div class="grid-btn" onclick="selectTradeOption('cap', '512GB', this)">512GB</div><div class="grid-btn" onclick="selectTradeOption('cap', '1TB', this)">1TB</div><div class="grid-btn" onclick="selectTradeOption('cap', '2TB', this)">2TB</div><div class="grid-btn" onclick="selectTradeOption('cap', 'å…¶ä»–', this)">å…¶ä»–</div></div><input type="hidden" id="trade-cap" required></div>
            <div class="form-group"><label>é¡è‰²</label>
                <div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="grid-btn" onclick="selectTradeOption('color', 'éŠ€', this)"><div class="phone-icon silver"></div>éŠ€</div>
                    <div class="grid-btn" onclick="selectTradeOption('color', 'æ©™', this)"><div class="phone-icon orange"></div>æ©™</div>
                    <div class="grid-btn" onclick="selectTradeOption('color', 'è—', this)"><div class="phone-icon blue"></div>è—</div>
                </div>
                <input type="hidden" id="trade-color" required>
            </div>
            
            <div class="form-group" style="margin-top:10px; display:flex; align-items:center; gap:10px;">
                <label>ç‹€æ…‹:</label>
                <div class="btn-grid" style="grid-template-columns: 1fr 1fr; width:100%; margin:0;">
                    <div class="grid-btn selected" onclick="selectTradeOption('condition', 'sealed', this)">ğŸ”’ åŸå°</div>
                    <div class="grid-btn" onclick="selectTradeOption('condition', 'opened', this)">ğŸ”ª é–‹å°</div>
                </div>
                <input type="hidden" id="trade-condition" value="sealed">
            </div>

            <div class="row-group"><div class="form-group"><label>åŸåƒ¹ (Cost)</label><input type="number" id="trade-cost" required></div><div class="form-group"><label>æ”¾å”® (Price)</label><input type="number" id="trade-price" required></div></div>
            <div class="form-group"><label>æ•¸é‡</label><div style="display:flex;gap:10px;"><button type="button" class="btn-small" onclick="adjustTradeQty(-1)">-</button><input type="number" id="trade-qty" value="1" style="text-align:center;"><button type="button" class="btn-small" onclick="adjustTradeQty(1)">+</button></div></div>
            <div class="form-group"><label>ä»˜æ¬¾ä¿¡ç”¨å¡</label><select id="trade-card"><option value="">ä¸ä½¿ç”¨ (åªè¨ˆåˆ©æ½¤)</option></select><div style="font-size:0.75rem; color:var(--text-muted);">*é¸å–å¾Œï¼Œæˆæœ¬å°‡è¨ˆå…¥è©²å¡ç°½è³¬ã€‚</div></div>
            <div class="form-group"><label>æ—¥æœŸæ™‚é–“</label><input type="datetime-local" id="trade-date" required></div>
            <button type="submit" id="btn-trade-submit" class="btn" style="background:var(--trade); color:#000;">è¨˜éŒ„äº¤æ˜“</button>
        </form>
    </div>
</div>

<div id="modal-split" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>âœ‚ï¸ åˆ†å–®</h2><div class="form-group"><input type="number" id="split-total" placeholder="ç¸½é¡" oninput="calcSplit()"></div><div class="row-group"><label><input type="checkbox" id="split-service" onchange="calcSplit()" style="width:auto;"> +10%</label><input type="number" id="split-discount" placeholder="æŠ˜æ‰£%" oninput="calcSplit()"></div><div class="form-group"><div style="display:flex;gap:10px;"><button type="button" class="btn-small" onclick="adjustPeople(-1)">-</button><input type="number" id="split-people" value="2" style="text-align:center;" oninput="calcSplit()"><button type="button" class="btn-small" onclick="adjustPeople(1)">+</button></div></div><div style="text-align:center; margin:15px;"><div id="split-result" style="font-size:2rem; font-weight:bold;">$0.00</div></div><button type="button" class="btn" onclick="applySplit()">å¡«å…¥</button></div></div>
<div id="modal-card" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>æ–°å¢å¡ç‰‡</h2><form id="card-form" onsubmit="addCard(event)"><div class="form-group"><input type="text" id="card-name" required placeholder="åç¨±"></div><div class="form-group"><select id="card-type" onchange="toggleCardRateInput()"><option value="cashback">ç¾é‡‘å›è´ˆ</option><option value="miles">é‡Œæ•¸</option></select></div><div class="row-group"><input type="number" id="card-rate" placeholder="Rate"><input type="number" id="card-rate-fx" placeholder="FX Rate"></div><div class="row-group"><input type="number" id="card-stmt-day" placeholder="æˆªæ•¸æ—¥"><input type="number" id="card-pay-gap" placeholder="é‚„æ¬¾æœŸ"></div><div class="form-group"><input type="number" id="card-cap" placeholder="ä¸Šé™"></div><div class="form-group"><input type="text" id="card-note" placeholder="å‚™è¨»"></div><button type="submit" class="btn">æ–°å¢</button></form></div></div>
<div id="modal-recur-mission" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>æ¯æœˆä»»å‹™</h2><div id="recur-list"></div><form onsubmit="addRecurMission(event)"><input type="text" id="recur-name" required placeholder="ä»»å‹™å"><div class="row-group"><input type="number" id="recur-target" required placeholder="ç›®æ¨™"><select id="recur-card" required></select></div><select id="recur-reset-day"><option value="1">1è™Ÿé‡ç½®</option><option value="12">12è™Ÿé‡ç½®</option></select><button type="submit" class="btn-small">+ åŠ å…¥</button></form></div></div>
<div id="modal-welcome" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>è¿æ–°ç›£å¯Ÿ</h2><div id="welcome-list"></div><form onsubmit="addWelcome(event)"><input type="text" id="welcome-name" required placeholder="è¿æ–°å"><div class="row-group"><select id="welcome-card" required></select><input type="number" id="welcome-target" required placeholder="ç›®æ¨™"></div><input type="date" id="welcome-deadline" required><input type="date" id="welcome-start" required><button type="submit" class="btn-small">+ åŠ å…¥</button></form></div></div>
<div id="modal-subs" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>å›ºå®šé–‹æ”¯</h2><div id="subs-list"></div><form onsubmit="addSubscription(event)"><input type="text" id="sub-name" required placeholder="é …ç›®"><div class="row-group"><input type="number" id="sub-amount" required placeholder="é‡‘é¡"><select id="sub-card" required></select></div><button type="submit" class="btn-small">+ åŠ å…¥</button></form></div></div>
<div id="modal-bank-info" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>éŠ€è¡Œè³‡è¨Š</h2><div id="bank-list"></div></div></div>
<div id="modal-data" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>å‚™ä»½</h2><button class="btn" onclick="exportData('json')">ä¸‹è¼‰ JSON</button><button class="btn" onclick="exportData('csv')">ä¸‹è¼‰ CSV</button><input type="file" id="file-input" onchange="importData(this)" style="display:none;"><button class="btn" onclick="triggerImport()">é‚„åŸ JSON</button><button class="btn-small" onclick="cleanDuplicateCards()">æ¸…ç†é‡è¤‡å¡</button><button class="btn-small" onclick="resetData()" style="color:var(--danger)">é‡ç½®è³‡æ–™</button></div></div>
<div id="modal-settings" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>è¨­å®š</h2><select id="setting-start-day" onchange="saveSettings()"></select><hr><input type="password" id="tg-token" placeholder="TG Token" onchange="saveTGSettings()"><input type="text" id="tg-chatid" placeholder="TG Chat ID" onchange="saveTGSettings()"><a href="#" onclick="testTG()">æ¸¬è©¦ç™¼é€</a><br><label><input type="checkbox" id="setting-tg-auto" onchange="saveSettings()" style="width:auto;"> è‡ªå‹•ç™¼é€</label><br><button class="btn-text" onclick="openModal('log')">æ›´æ–°æ—¥èªŒ</button></div></div>
<div id="modal-mission" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>é™æ™‚ä»»å‹™</h2><form onsubmit="addMission(event)"><input type="text" id="mission-name" required placeholder="ä»»å‹™å"><input type="number" id="mission-target" required placeholder="ç›®æ¨™"><div class="row-group"><input type="date" id="mission-start"><input type="date" id="mission-end"></div><div id="mission-cards" class="checkbox-group"></div><button type="submit" class="btn">å»ºç«‹</button></form></div></div>
<div id="modal-log" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">Ã—</button>
        <h2>æ›´æ–°æ—¥èªŒ</h2>
        <div class="log-list">
            <div class="log-item"><div class="log-date">v1.69 (List Style)</div><div class="log-content">- æ–°å¢ï¼šè³¼å…¥ä¾†æº/å›æ”¶åº—æ”¹ç‚ºä¸‹æ‹‰åˆ—è¡¨ã€‚<br>- æ–°å¢ï¼šè¨‚å–®ç·¨è™Ÿæ¬„ä½ã€‚<br>- ä¿®å¾©ï¼šå ±å‘Šåˆ©æ½¤è¨ˆç®—ã€‚<br>- UIï¼šé—œé–‰æŒ‰éˆ•å„ªåŒ–ã€‚</div></div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // Global Error Handler
    window.onerror = function(msg, url, line, col, error) {
        const div = document.getElementById('error-console');
        if(div) {
            div.style.display = 'block';
            div.innerHTML += `ğŸ”´ Error: ${msg} <br>Line: ${line}<br>`;
        }
        console.error(error);
        return false;
    };

    // Config
    const DB_KEY='rebate_bro_data_v2', BACKUP_TIME_KEY='rebate_bro_backup_time';
    const CURRENCIES = ['HKD', 'CNY', 'USD', 'JPY', 'TWD', 'GBP', 'EUR', 'KRW', 'AUD', 'SGD'];
    
    // SOURCES (Where bought)
    const TRADE_SOURCES = ['AOS (å®˜ç¶²)', 'APU (åº—å–)', 'ç™¾è€åŒ¯', 'è±æ¾¤', 'å‹å’Œ', 'è˜‡å¯§', 'é›»å™¨å¹«', 'CMHK', 'CSL', 'Smartone', '3HK', 'HKTVMall', 'äº¬æ±', 'å…ç¨…åº—'];
    // SHOPS (Where sold)
    const TRADE_SHOPS = ['é›ªçƒ', 'è¬é€š', 'æ—¥éŸ“', 'èª ä¿¡', 'bobo', 'YY', 'G79', 'F9', 'DIY', 'æ–°å®‡å®™', 'æº«è¨˜', 'éµ¬ç¨‹', 'iTrade', 'æ˜Ÿè€€', 'Carousell'];
    
    const IPHONE_PRICES = { 'Pro': { '256GB': 9399, '512GB': 11099, '1TB': 12799 }, 'Pro Max': { '256GB': 10199, '512GB': 11899, '1TB': 13599, '2TB': 16999 } };
    const CATEGORIES = { expense: ['é£Ÿé£¯', 'æ­è»Š', 'è³¼ç‰©', 'å¨›æ¨‚', 'é›œè²»', 'å…¶ä»–', 'å›ºå®šé–‹æ”¯'], income: ['è–ªé‡‘', 'è³£é‡', 'æŠ•è³‡', 'å…¶ä»–'], repayment: ['ä¿¡ç”¨å¡é‚„æ¬¾'] };
    const PRESET_CARDS = [ { name: 'ç¾é‡‘', type: 'cashback', rate: 0 }, { name: 'WeWa', type: 'cashback', rate: 10 } ];
    
    // FULL BANK INFO RESTORED
    const BANK_INFO = [
        { name: 'HSBC åŒ¯è±', promoUrl: 'https://www.redhotoffers.hsbc.com.hk/', rewardUrl: 'https://www.hsbc.com.hk/zh-hk/credit-cards/rewards/reward-cash/', csPhone: '2233 3000', csTrick: 'é¸èªè¨€ > 1 > 0' },
        { name: 'Standard Chartered æ¸£æ‰“', promoUrl: 'https://www.sc.com/hk/zh/credit-cards/promotion/', rewardUrl: 'https://www.sc.com/hk/zh/credit-cards/360-rewards/', csPhone: '2886 4111', csTrick: 'é¸èªè¨€ > 2 > 0' },
        { name: 'Hang Seng æ’ç”Ÿ', promoUrl: 'https://www.hangseng.com/zh-hk/personal/cards/', rewardUrl: 'https://www.hangseng.com/zh-hk/personal/cards/cash-dollars/', csPhone: '2998 9188', csTrick: 'é¸èªè¨€ > 1 > 0' },
        { name: 'BOC ä¸­éŠ€é¦™æ¸¯', promoUrl: 'https://www.bochk.com/tc/creditcard/promotions.html', rewardUrl: 'https://www.bochk.com/tc/creditcard/reward.html', csPhone: '2853 8828', csTrick: 'é¸èªè¨€ > 1 > 0' },
        { name: 'DBS æ˜Ÿå±•', promoUrl: 'https://www.dbs.com.hk/personal-zh/credit-cards/promotions/default.page', rewardUrl: 'https://www.dbs.com.hk/personal-zh/credit-cards/rewards.page', csPhone: '2290 8888', csTrick: 'é¸èªè¨€ > 1 > 0' },
        { name: 'Citi èŠ±æ——', promoUrl: 'https://www1.citibank.com.hk/chinese/credit-cards/promotions', rewardUrl: 'https://www1.citibank.com.hk/chinese/credit-cards/rewards', csPhone: '2860 0333', csTrick: 'é¸èªè¨€ > *0' },
        { name: 'BEA æ±äº', promoUrl: 'https://www.hkbea.com/html/tc/bea-credit-card-spending-offer.html', rewardUrl: '', csPhone: '3608 6628', csTrick: 'é¸èªè¨€ > 1 > 9' },
        { name: 'EarnMORE / WeWa', promoUrl: 'https://www.primecredit.com/credit-card/latest-offer/', rewardUrl: 'https://www.primecredit.com/credit-card/wewa-club/', csPhone: '2269 8888', csTrick: 'é¸èªè¨€ > 0' }
    ];

    // State
    let state = { transactions: [], cards: [], missions: [], recurringMissions: [], subscriptions: [], trades: [], welcomeOffers: [], settings: { startDay: 1 } };
    let pieChart = null, barChart = null, transferringTxId = null, analysisMode = 'month';

    // Core
    function init() {
        try {
            const s = localStorage.getItem(DB_KEY);
            if(s) state = JSON.parse(s);
            if(!state.cards) state.cards = [];
            if(!state.settings) state.settings = { startDay: 1 };
            
            const dS = document.getElementById('setting-start-day');
            if(dS) { dS.innerHTML=''; for(let i=1;i<=31;i++) { let o=document.createElement('option'); o.value=i; o.text=i+'è™Ÿ'; dS.add(o); } dS.value=state.settings.startDay; }
            
            const cS = document.getElementById('tx-currency');
            if(cS) { cS.innerHTML=''; CURRENCIES.forEach(c=>{ let o=document.createElement('option'); o.value=c; o.text=c; cS.add(o); }); }
            
            // Build Source Select
            const sourceS = document.getElementById('trade-source');
            if(sourceS) { 
                sourceS.innerHTML=''; 
                TRADE_SOURCES.forEach(src=>{ 
                    let o=document.createElement('option'); o.value=src; o.text=src; 
                    sourceS.add(o); 
                }); 
            }

            // Build Shop Select
            const shopS = document.getElementById('trade-shop');
            if(shopS) { 
                // shopS.innerHTML='<option value="">-- è«‹é¸æ“‡ (æœªè³£å‡ºå¯ä¸å¡«) --</option>'; // Already in HTML
                TRADE_SHOPS.forEach(sh=>{ 
                    let o=document.createElement('option'); o.value=sh; o.text=sh; 
                    shopS.add(o); 
                }); 
            }

            if(state.settings.tgToken) document.getElementById('tg-token').value = state.settings.tgToken;
            if(state.settings.tgChatId) document.getElementById('tg-chatid').value = state.settings.tgChatId;
            if(document.getElementById('setting-tg-auto')) document.getElementById('setting-tg-auto').checked = state.settings.tgAutoSend;
            if(document.getElementById('tx-tg-auto')) document.getElementById('tx-tg-auto').checked = state.settings.tgAutoSend;

            setDefaultTime();
            setAnalysisMode('month');
            render();
            
            const url = new URLSearchParams(window.location.search);
            if(url.get('new_tx')==='true') openModal('transaction');
            
        } catch(e) { console.error(e); alert("Init Error: " + e.message); }
    }
    
    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }
    function resetData() { if(confirm('Reset?')) { localStorage.removeItem(DB_KEY); location.reload(); } }
    function rescueData() { const d = localStorage.getItem(DB_KEY); if(d) { const b = new Blob([d], {type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.json'; a.click(); } }

    // Renders
    function render() {
        renderCards(); renderTransactions(); renderTrading(); updateFormOptions(); calculateStats();
        if(document.getElementById('tab-analysis').classList.contains('active')) renderCharts();
    }
    
    function renderCards() {
        const l = document.getElementById('card-list'); l.innerHTML = '';
        if(state.cards.length === 0) l.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">æœªæœ‰ä¿¡ç”¨å¡</div>';
        state.cards.forEach(c => {
            const r = c.rate !== undefined ? c.rate : (c.percent || 0);
            const capText = c.cap > 0 ? ` / $${c.cap.toLocaleString()}` : '';
            l.innerHTML += `
                <div class="credit-card">
                    <div style="display:flex; justify-content:space-between;">
                        <div><div class="card-name">${c.name}</div><div class="card-info">${r}%</div></div>
                        <div><button class="btn-text" onclick="quickRepay(${c.id})">é‚„</button><button class="btn-text" onclick="deleteCard(${c.id})">X</button></div>
                    </div>
                    <div class="progress-bar"><div id="prog-${c.id}" class="progress-fill"></div></div>
                    <div class="card-info" style="margin-top:5px;display:flex;justify-content:space-between;">
                         <span>ç°½: <span id="spent-${c.id}">0</span>${capText}</span>
                         <span>é‚„: <span id="paid-${c.id}">0</span></span>
                    </div>
                </div>`;
        });
    }

    function renderTransactions() {
        const l = document.getElementById('transaction-list'); l.innerHTML = '';
        const sorted = [...state.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
        if(sorted.length === 0) l.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">æš«ç„¡ç´€éŒ„</div>';
        sorted.forEach(tx => {
            const card = state.cards.find(c => c.id == tx.cardId);
            const cName = card ? card.name : '';
            const color = tx.type === 'income' ? 'var(--income)' : (tx.type === 'repayment' ? 'var(--repay)' : 'var(--text)');
            const sign = tx.type === 'income' ? '+' : (tx.type === 'repayment' ? '-' : '');
            let xtra = ''; if(tx.currency && tx.currency!=='HKD') xtra=`<br><small>${tx.currency} ${tx.fxAmount}</small>`;
            l.innerHTML += `<div class="list-item"><div class="item-main"><div class="item-title">${tx.category} ${tx.desc}</div><div class="item-sub">${tx.date.slice(0,16).replace('T',' ')} â€¢ ${cName}</div></div><div style="text-align:right"><div class="item-amount" style="color:${color}">${sign}$${tx.amount}${xtra}</div><button class="btn-text" onclick="editTransaction(${tx.id})">âœ</button></div></div>`;
        });
    }
    
    function renderTrading() {
        const l = document.getElementById('trade-list'); l.innerHTML = '';
        if(state.trades.length === 0) l.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">æš«ç„¡äº¤æ˜“</div>';
        const sortedTrades = [...state.trades].sort((a,b) => new Date(b.date) - new Date(a.date));
        sortedTrades.forEach(t => {
            // Status Logic
            let statusBadge = '';
            let profitDisplay = '';
            let locationDisplay = '';

            if (t.status === 'pending') statusBadge = '<span class="status-badge status-ordered">ğŸ›’ å·²è¨‚</span>';
            else if (t.status === 'stock') statusBadge = '<span class="status-badge status-stock">ğŸ“¦ ç¾è²¨</span>';
            else if (t.status === 'cut') statusBadge = '<span class="status-badge status-cut">âŒ Cutå–®</span>';
            else {
                // Sold
                statusBadge = '<span class="status-badge status-sold">ğŸ’° å·²è³£</span>';
                if(t.condition === 'opened') statusBadge += '<span class="status-badge status-cut" style="text-decoration:none;">ğŸ”ª</span>';
                const pClass = t.profit >= 0 ? 'profit-pos' : 'profit-neg';
                profitDisplay = `<span class="${pClass}">$${t.profit}</span>`;
            }
            
            // Logic for showing location
            const source = t.source || 'æœªçŸ¥';
            // Show OID if exists
            const oidText = t.oid ? `(å–®è™Ÿ:${t.oid})` : '';
            
            if (t.status === 'sold' && t.shop) locationDisplay = `${source} ${oidText} â” ${t.shop}`;
            else locationDisplay = `${source} ${oidText}`;

            const card = state.cards.find(c => c.id == t.cardId);
            const cName = card ? `<span class="cat-tag" style="font-size:0.6rem">ğŸ’³ ${card.name}</span>` : '';
            
            l.innerHTML += `
                <div class="list-item">
                    <div class="item-main">
                        <div class="item-title">${statusBadge} ${t.model} ${t.cap}</div>
                        <div class="item-sub">${locationDisplay} â€¢ ${t.date.slice(0,10)} ${cName}</div>
                    </div>
                    <div>
                        <div class="item-amount" style="font-size:0.9rem;">x${t.qty} ${profitDisplay}</div>
                        <div style="display:flex; justify-content:flex-end;">
                            <button class="btn-text" onclick="editTrade(${t.id})">âœ</button>
                            <button class="btn-text" onclick="deleteTrade(${t.id})">X</button>
                        </div>
                    </div>
                </div>`;
        });
    }

    function calculateStats() {
        let spent=0, inc=0, repay=0, cash=0, miles=0;
        const cardSpent = {}, cardPaid = {};
        state.cards.forEach(c=>{ cardSpent[c.id]=0; cardPaid[c.id]=0; });

        const {start, end} = getFinancialMonthRange();
        const cycle = document.getElementById('billing-cycle-text');
        if(cycle) cycle.innerText = `(${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()})`;
        
        // 1. Transactions
        state.transactions.forEach(tx => {
            const d = new Date(tx.date);
            if(d>=start && d<=end) {
                if(tx.type==='expense') {
                    spent += tx.amount;
                    const c = state.cards.find(x=>x.id==tx.cardId);
                    if(c) {
                        cardSpent[c.id] += tx.amount;
                        const r = tx.isForeign ? (c.rateFx||0) : (c.rate||0);
                        if(c.type==='miles' && r>0) miles += Math.floor(tx.amount/r);
                        else cash += (tx.amount * r / 100);
                    }
                } else if(tx.type==='income') inc += tx.amount;
                else if(tx.type==='repayment') {
                    repay += tx.amount;
                    if(tx.cardId) cardPaid[tx.cardId] += tx.amount;
                }
            }
        });

        // 2. Trades (Integrated Logic - Count all non-sold status as Cost used on card)
        state.trades.forEach(t => {
            const d = new Date(t.date);
            if(t.cardId && d>=start && d<=end) {
                const totalCost = t.cost * t.qty;
                cardSpent[t.cardId] += totalCost;
                
                // Rewards logic
                const c = state.cards.find(x=>x.id==t.cardId);
                if(c) {
                     const r = c.rate || 0; 
                     if(c.type==='miles' && r>0) miles += Math.floor(totalCost/r);
                     else cash += (totalCost * r / 100);
                }
            }
        });

        document.getElementById('total-spent').innerText = '$'+spent.toLocaleString();
        document.getElementById('total-income').innerText = '$'+inc.toLocaleString();
        document.getElementById('total-repaid').innerText = '$'+repay.toLocaleString();
        document.getElementById('total-cashback').innerText = '$'+cash.toFixed(1) + (miles>0 ? ` + ${miles} AM` : '');

        // Update Cards
        state.cards.forEach(c => {
             const s = cardSpent[c.id] || 0;
             const p = cardPaid[c.id] || 0;
             const elS = document.getElementById('spent-'+c.id); if(elS) elS.innerText = '$'+s.toLocaleString();
             const elP = document.getElementById('paid-'+c.id); if(elP) elP.innerText = '$'+p.toLocaleString();
             const elBar = document.getElementById('prog-'+c.id); 
             if(elBar) {
                 const pct = c.cap > 0 ? Math.min((s/c.cap)*100, 100) : 0;
                 elBar.style.width = pct+'%';
                 elBar.style.backgroundColor = pct>=100 ? 'var(--danger)' : 'var(--primary)';
             }
        });
    }
    
    // Charts (Full Logic)
    function renderCharts() {
        if(!document.getElementById('chart-cards')) return;
        const style = getComputedStyle(document.body);
        const textColor = style.getPropertyValue('--chart-text').trim();
        const colors = ['#00d26a', '#4facfe', '#ff6b6b', '#fca5a5', '#ffd93d', '#a855f7', '#a29bfe'];
        
        let txs = [], labelX = [], dataSets = [];
        
        const includeTrade = document.getElementById('analysis-include-trade').checked;
        let pool = [...state.transactions];
        if(includeTrade) {
            state.trades.forEach(t => {
                pool.push({ date: t.date, amount: t.cost * t.qty, type: 'expense', cardId: t.cardId, category: 'ç‚’è³£' });
            });
        }

        if (analysisMode === 'month') {
             const m = document.getElementById('analysis-month').value;
             if(!m) return;
             txs = pool.filter(tx => tx.date.startsWith(m) && (tx.type === 'expense'));
             const days = new Date(parseInt(m.slice(0,4)), parseInt(m.slice(5,7)), 0).getDate();
             labelX = Array.from({length: days}, (_, i) => (i + 1).toString());
             const daily = new Array(days).fill(0);
             txs.forEach(tx => { daily[parseInt(tx.date.slice(8, 10)) - 1] += tx.amount; });
             dataSets.push({ label: 'æ”¯å‡º', data: daily, backgroundColor: '#ff4d4d', borderRadius: 3 });

        } else if (analysisMode === 'range') {
             const sVal = document.getElementById('analysis-start').value;
             const eVal = document.getElementById('analysis-end').value;
             if(!sVal || !eVal) return;
             const s = new Date(sVal); const e = new Date(eVal); e.setHours(23,59,59);
             txs = pool.filter(tx => { const d = new Date(tx.date); return (tx.type === 'expense') && d >= s && d <= e; });
             const map = {}; txs.forEach(tx => { const dStr = tx.date.slice(5,10); map[dStr] = (map[dStr] || 0) + tx.amount; });
             labelX = Object.keys(map).sort(); dataSets.push({ label: 'æ”¯å‡º', data: labelX.map(d => map[d]), backgroundColor: '#ff4d4d' });

        } else if (analysisMode === 'compare') {
             const m1 = document.getElementById('analysis-m1').value;
             const m2 = document.getElementById('analysis-m2').value;
             if(!m1 || !m2) return;
             if(pieChart) { pieChart.destroy(); pieChart=null; }
             const tx1 = pool.filter(tx => tx.date.startsWith(m1) && tx.type === 'expense');
             const tx2 = pool.filter(tx => tx.date.startsWith(m2) && tx.type === 'expense');
             const cats = CATEGORIES.expense.concat(['ç‚’è³£']);
             const d1 = cats.map(c => tx1.filter(t => t.category === c).reduce((sum, t) => sum + t.amount, 0));
             const d2 = cats.map(c => tx2.filter(t => t.category === c).reduce((sum, t) => sum + t.amount, 0));
             labelX = cats; dataSets = [ { label: m1, data: d1, backgroundColor: '#4facfe' }, { label: m2, data: d2, backgroundColor: '#ff4d4d' } ];
             if(barChart) barChart.destroy();
             barChart = new Chart(document.getElementById('chart-daily').getContext('2d'), { type: 'bar', data: { labels: labelX, datasets: dataSets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid: { display: false } }, y: { ticks: { color: textColor }, grid: { color: '#333' } } }, plugins: { legend: { display: false } } } });
             return;
        }

        const cardTotals = {}; state.cards.forEach(c => cardTotals[c.name] = 0); 
        txs.forEach(tx => { const card = state.cards.find(c => c.id == tx.cardId); if(card) cardTotals[card.name] += tx.amount; });
        const pieD = Object.keys(cardTotals).filter(k => cardTotals[k] > 0).map(k => cardTotals[k]);
        const pieL = Object.keys(cardTotals).filter(k => cardTotals[k] > 0);

        if(pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById('chart-cards').getContext('2d'), { type: 'doughnut', data: { labels: pieL, datasets: [{ data: pieD, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: textColor } } } } });

        if(barChart) barChart.destroy();
        barChart = new Chart(document.getElementById('chart-daily').getContext('2d'), { type: 'bar', data: { labels: labelX, datasets: dataSets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid: { display: false } }, y: { ticks: { color: textColor }, grid: { color: '#333' } } }, plugins: { legend: { display: false } } } });
    }

    // Helpers
    function getFinancialMonthRange() {
        const s = state.settings.startDay || 1;
        const now = new Date();
        let start, end;
        if(now.getDate() >= s) { start = new Date(now.getFullYear(), now.getMonth(), s); end = new Date(now.getFullYear(), now.getMonth()+1, s-1); } 
        else { start = new Date(now.getFullYear(), now.getMonth()-1, s); end = new Date(now.getFullYear(), now.getMonth(), s-1); }
        return {start, end};
    }
    function setDefaultTime() { 
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('tx-date').value = now.toISOString().slice(0,16); 
        const tradeDate = document.getElementById('trade-date');
        if(tradeDate) tradeDate.value = now.toISOString().slice(0,16);
    }
    
    // Actions
    function switchTab(name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        if(name==='transactions') { document.querySelectorAll('.tab')[0].classList.add('active'); document.getElementById('tab-transactions').classList.add('active'); }
        else if(name==='cards') { document.querySelectorAll('.tab')[1].classList.add('active'); document.getElementById('tab-cards').classList.add('active'); }
        else if(name==='trading') { document.querySelectorAll('.tab')[2].classList.add('active'); document.getElementById('tab-trading').classList.add('active'); renderTrading(); }
        else if(name==='analysis') { document.querySelectorAll('.tab')[3].classList.add('active'); document.getElementById('tab-analysis').classList.add('active'); renderCharts(); }
    }
    
    function openModal(type) {
        document.getElementById('modal-'+type).classList.add('active');
        if(type==='transaction') {
            document.getElementById('tx-form').reset();
            document.getElementById('tx-id').value='';
            setTxType('expense');
            setDefaultTime();
        }
        if(type==='trade') {
             if (!document.getElementById('trade-id').value) {
                document.getElementById('trade-form').reset();
                document.getElementById('trade-id').value = '';
                document.getElementById('trade-qty').value = 1;
                document.getElementById('trade-status').value = 'pending';
                document.getElementById('trade-condition').value = 'sealed';
                // Clean visuals
                document.querySelectorAll('.grid-btn.selected').forEach(b => b.classList.remove('selected'));
                setDefaultTime();
             }
             updateFormOptions();
        }
    }
    
    function closeModals() { 
        document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); 
        document.getElementById('trade-id').value = '';
    }
    function openMenuTarget(t) { closeModals(); setTimeout(()=>openModal(t), 50); }
    
    function setTxType(t) {
        document.getElementById('tx-type').value=t;
        document.querySelectorAll('.type-option').forEach(e=>e.classList.remove('active','expense','income','repayment'));
        document.getElementById('type-'+t).classList.add('active', t);
        
        const catS = document.getElementById('tx-category'); catS.innerHTML='';
        CATEGORIES[t].forEach(c=>{ let o=document.createElement('option'); o.value=c; o.text=c; catS.add(o); });
        
        document.getElementById('group-card').style.display = t==='income'?'none':'block';
        updateCardHint();
    }
    
    function updateCardHint() {
        const cid = document.getElementById('tx-card').value;
        const c = state.cards.find(x=>x.id==cid);
        const h = document.getElementById('card-hint');
        if(c && document.getElementById('tx-type').value==='expense') {
            h.style.display='block'; h.innerText = `å›è´ˆ: ${c.rate||0}%`;
        } else { h.style.display='none'; }
    }
    
    function updateFormOptions() {
        const s = document.getElementById('tx-card'); s.innerHTML='';
        const ts = document.getElementById('trade-card'); if(ts) ts.innerHTML='<option value="">ä¸ä½¿ç”¨ (åªè¨ˆåˆ©æ½¤)</option>';
        const ws = document.getElementById('welcome-card'); if(ws) ws.innerHTML='';
        const rs = document.getElementById('recur-card'); if(rs) rs.innerHTML='';

        state.cards.forEach(c => {
            let o = document.createElement('option'); o.value=c.id; o.text=c.name;
            s.add(o);
            if(ts) { let o2=document.createElement('option'); o2.value=c.id; o2.text=c.name; ts.add(o2); }
            if(ws) { let o3=document.createElement('option'); o3.value=c.id; o3.text=c.name; ws.add(o3); }
            if(rs) { let o4=document.createElement('option'); o4.value=c.id; o4.text=c.name; rs.add(o4); }
        });
        updateCardHint();
    }

    function handleTransactionSubmit(e) {
        e.preventDefault();
        const idStr = document.getElementById('tx-id').value;
        const tx = {
            id: idStr ? parseFloat(idStr) : Date.now(),
            type: document.getElementById('tx-type').value,
            amount: parseFloat(document.getElementById('tx-amount').value),
            category: document.getElementById('tx-category').value,
            cardId: document.getElementById('tx-card').value,
            desc: document.getElementById('tx-desc').value,
            date: document.getElementById('tx-date').value,
            currency: document.getElementById('tx-currency').value,
            fxAmount: parseFloat(document.getElementById('tx-fx-amount').value)||0
        };
        
        if(idStr) {
            const idx = state.transactions.findIndex(t=>t.id==tx.id);
            if(idx!==-1) state.transactions[idx] = tx;
        } else {
            state.transactions.unshift(tx);
            if(state.settings.tgAutoSend) sendTelegramTx(tx);
        }
        saveData(); render(); closeModals();
    }
    
    function editTransaction(id) {
        const tx = state.transactions.find(t=>t.id==id);
        if(!tx) return;
        openModal('transaction');
        document.getElementById('tx-id').value=tx.id;
        setTxType(tx.type);
        document.getElementById('tx-amount').value=tx.amount;
        document.getElementById('tx-desc').value=tx.desc;
        document.getElementById('tx-date').value=tx.date;
        if(tx.cardId) document.getElementById('tx-card').value=tx.cardId;
        document.getElementById('tx-modal-title').innerText="ç·¨è¼¯";
    }
    
    function deleteTransaction(id) { if(confirm('Del?')) { state.transactions=state.transactions.filter(t=>t.id!==id); saveData(); render(); } }
    function deleteCard(id) { if(confirm('Del?')) { state.cards=state.cards.filter(c=>c.id!==id); saveData(); render(); } }
    function deleteTrade(id) { if(confirm('Del?')) { state.trades=state.trades.filter(t=>t.id!==id); saveData(); render(); } }

    function addCard(e) {
        e.preventDefault();
        state.cards.push({
            id: Date.now(),
            name: document.getElementById('card-name').value,
            rate: parseFloat(document.getElementById('card-rate').value)||0,
            cap: parseFloat(document.getElementById('card-cap').value)||0,
            note: document.getElementById('card-note').value
        });
        saveData(); render(); closeModals();
    }

    function addTrade(e) {
        e.preventDefault();
        const idStr = document.getElementById('trade-id').value;
        const cost = parseFloat(document.getElementById('trade-cost').value);
        const price = parseFloat(document.getElementById('trade-price').value);
        const qty = parseInt(document.getElementById('trade-qty').value);
        const cid = document.getElementById('trade-card').value;
        const dateVal = document.getElementById('trade-date').value;
        const status = document.getElementById('trade-status').value || 'pending';
        const condition = document.getElementById('trade-condition').value || 'sealed';
        const source = document.getElementById('trade-source').value || 'N/A';
        const shop = document.getElementById('trade-shop').value || '';
        const oid = document.getElementById('trade-oid').value || '';

        const tradeData = {
            source, shop, oid,
            model: document.getElementById('trade-model').value,
            cap: document.getElementById('trade-cap').value,
            color: document.getElementById('trade-color').value,
            cost, price, qty, profit: (price-cost)*qty,
            date: dateVal ? new Date(dateVal).toISOString() : new Date().toISOString(),
            cardId: cid,
            status, condition
        };

        if (idStr) {
            const id = parseFloat(idStr);
            const idx = state.trades.findIndex(t => t.id === id);
            if (idx !== -1) state.trades[idx] = { ...state.trades[idx], ...tradeData };
        } else {
            state.trades.unshift({ id: Date.now(), ...tradeData });
        }
        saveData(); render(); closeModals();
    }
    
    function editTrade(id) {
        const t = state.trades.find(x => x.id === id);
        if (!t) return;
        
        openModal('trade');
        document.getElementById('trade-id').value = t.id;
        document.getElementById('trade-source').value = t.source || "";
        document.getElementById('trade-shop').value = t.shop || "";
        document.getElementById('trade-oid').value = t.oid || "";
        document.getElementById('trade-model').value = t.model;
        document.getElementById('trade-cap').value = t.cap;
        document.getElementById('trade-color').value = t.color;
        document.getElementById('trade-cost').value = t.cost;
        document.getElementById('trade-price').value = t.price;
        document.getElementById('trade-qty').value = t.qty;
        document.getElementById('trade-card').value = t.cardId || "";
        document.getElementById('trade-date').value = t.date.slice(0,16);
        document.getElementById('trade-status').value = t.status || 'pending';
        document.getElementById('trade-condition').value = t.condition || 'sealed';

        // Update Visual Selection (Including Condition)
        ['source', 'shop', 'model', 'cap', 'color', 'status', 'condition'].forEach(type => {
            const val = t[type];
            let grid;
            if(type==='source') grid = document.getElementById('trade-source').parentElement.querySelector('.btn-grid'); // No grid now
            else if(type==='status' || type==='condition') {
                 const input = document.getElementById('trade-'+type);
                 if(input) grid = input.parentElement.querySelector('.btn-grid');
            }
            else {
                const hiddenInput = document.getElementById('trade-'+type);
                if(hiddenInput) grid = hiddenInput.parentElement.querySelector('.btn-grid');
            }
            
            // Note: Source and Shop are selects now, so no grid update needed for them.
            if (grid) {
                Array.from(grid.children).forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.innerText.includes(val) || btn.innerText === val) {
                        btn.classList.add('selected');
                    }
                });
            }
        });
    }

    function quickRepay(cid) {
        openModal('transaction'); setTxType('repayment');
        document.getElementById('tx-card').value = cid;
        document.getElementById('tx-amount').focus();
    }

    function addWelcome(e) { e.preventDefault(); state.welcomeOffers.push({id:Date.now(), name:document.getElementById('welcome-name').value, cardId:document.getElementById('welcome-card').value, target:parseFloat(document.getElementById('welcome-target').value), deadline:document.getElementById('welcome-deadline').value, start:document.getElementById('welcome-start').value}); saveData(); renderWelcomeList(); e.target.reset(); }
    function deleteWelcome(id) { if(confirm('Del?')) { state.welcomeOffers=state.welcomeOffers.filter(w=>w.id!==id); saveData(); renderWelcomeList(); } }
    
    function addRecurMission(e) { e.preventDefault(); state.recurringMissions.push({id:Date.now(), name:document.getElementById('recur-name').value, target:parseFloat(document.getElementById('recur-target').value), cardId:document.getElementById('recur-card').value, resetDay:parseInt(document.getElementById('recur-reset-day').value)}); saveData(); renderRecurList(); e.target.reset(); }
    function deleteRecurMission(id) { if(confirm('Del?')) { state.recurringMissions=state.recurringMissions.filter(m=>m.id!==id); saveData(); renderRecurList(); } }

    function addSubscription(e) { e.preventDefault(); state.subscriptions.push({id:Date.now(), name:document.getElementById('sub-name').value, amount:parseFloat(document.getElementById('sub-amount').value), cardId:document.getElementById('sub-card').value}); saveData(); renderSubsList(); e.target.reset(); }
    function deleteSub(id) { if(confirm('Del?')) { state.subscriptions=state.subscriptions.filter(s=>s.id!==id); saveData(); renderSubsList(); } }

    // UI Helpers
    function selectTradeOption(type, val, el) {
        document.getElementById('trade-'+type).value=val;
        if(el.parentElement) Array.from(el.parentElement.children).forEach(c=>c.classList.remove('selected'));
        el.classList.add('selected');
        if(type==='model' || type==='cap') {
            const m = document.getElementById('trade-model').value;
            const c = document.getElementById('trade-cap').value;
            if(m && c && IPHONE_PRICES[m] && IPHONE_PRICES[m][c]) document.getElementById('trade-cost').value = IPHONE_PRICES[m][c];
        }
    }
    function adjustTradeQty(d) {
        const i = document.getElementById('trade-qty');
        i.value = Math.max(1, parseInt(i.value)+d);
    }
    function importPresetCards() {
        PRESET_CARDS.forEach(p=> { if(!state.cards.find(c=>c.name===p.name)) state.cards.push({...p, id: Date.now()+Math.random()}) });
        saveData(); render();
    }
    function toggleTheme() {
        const h = document.documentElement;
        h.setAttribute('data-theme', h.getAttribute('data-theme')==='dark'?'light':'dark');
    }
    function handleCurrencyChange() {
        const c = document.getElementById('tx-currency').value;
        document.getElementById('fx-rate-container').style.display = c==='HKD'?'none':'block';
        document.getElementById('fx-amount-container').style.display = c==='HKD'?'none':'block';
    }
    function calcHkdAmount() {
        const amt = parseFloat(document.getElementById('tx-fx-amount').value)||0;
        const rate = parseFloat(document.getElementById('tx-fx-rate').value)||0;
        if(amt && rate) document.getElementById('tx-amount').value = (amt*rate).toFixed(2);
    }
    function calcSplit() {
        const t = parseFloat(document.getElementById('split-total').value)||0;
        const dis = parseFloat(document.getElementById('split-discount').value)||0;
        const svc = document.getElementById('split-service').checked;
        const p = parseInt(document.getElementById('split-people').value)||1;
        let final = t;
        if(svc) final *= 1.1;
        if(dis) final *= (1-dis/100);
        document.getElementById('split-result').innerText = '$'+(final/p).toFixed(2);
    }
    function adjustPeople(d) {
        const i = document.getElementById('split-people');
        i.value = Math.max(1, parseInt(i.value)+d);
        calcSplit();
    }
    function applySplit() {
        document.getElementById('tx-amount').value = parseFloat(document.getElementById('split-result').innerText.replace('$',''));
        closeModals();
    }
    function setAnalysisMode(mode) {
        analysisMode = mode;
        const btns = document.querySelectorAll('.analysis-btn');
        if(btns) btns.forEach(b => b.classList.remove('active'));
        const activeBtn = document.getElementById(`btn-mode-${mode}`);
        if(activeBtn) activeBtn.classList.add('active');
        
        const container = document.getElementById('analysis-inputs');
        if(!container) return;
        container.innerHTML = '';
        if(mode==='month') {
            container.innerHTML = `<input type="month" id="analysis-month" value="${new Date().toISOString().slice(0,7)}" onchange="renderCharts()">`;
        } else if(mode==='range') {
            container.innerHTML = `<input type="date" id="analysis-start" onchange="renderCharts()"> - <input type="date" id="analysis-end" onchange="renderCharts()">`;
        } else {
             container.innerHTML = `<input type="month" id="analysis-m1" onchange="renderCharts()"> vs <input type="month" id="analysis-m2" onchange="renderCharts()">`;
        }
        setTimeout(renderCharts, 100);
    }

    // TG
    function saveSettings() {
        state.settings.startDay = parseInt(document.getElementById('setting-start-day').value);
        state.settings.tgAutoSend = document.getElementById('setting-tg-auto').checked;
        saveData(); render(); closeModals(); showToast('Saved');
    }
    function saveTGSettings() {
        state.settings.tgToken = document.getElementById('tg-token').value;
        state.settings.tgChatId = document.getElementById('tg-chatid').value;
        saveData();
    }
    function testTG() { sendTGMessage(state.settings.tgToken, state.settings.tgChatId, 'Test'); }
    
    async function sendTGMessage(t, cid, msg) {
        if (!t || !cid) { alert('è«‹å…ˆè¨­å®š TG Token & Chat ID'); return; }
        try { 
            const res = await fetch(`https://api.telegram.org/bot${t}/sendMessage`, {
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({chat_id:cid, text:msg, parse_mode:'Markdown'})
            });
            if(res.status === 200) showToast('âœ… TG ç™¼é€æˆåŠŸ');
            else { 
                const err = await res.json();
                console.error('TG API Error:', err);
                alert(`TG ç™¼é€å¤±æ•—: ${err.description}`); 
            }
        } catch(e){ 
            console.error(e); 
        }
    }

    function sendTelegramTx(tx) {
        if(!state.settings.tgAutoSend) return;
        const card = state.cards.find(c => c.id == tx.cardId);
        const cardName = card ? card.name : 'N/A';
        const dateObj = new Date(tx.date);
        const dateStr = `${dateObj.getFullYear()}-${(dateObj.getMonth()+1).toString().padStart(2,'0')}-${dateObj.getDate().toString().padStart(2,'0')} ${dateObj.getHours().toString().padStart(2,'0')}:${dateObj.getMinutes().toString().padStart(2,'0')}`;
        
        let msg = `ğŸ”” *æ–°å¢è¨˜è³¬*\n`;
        msg += `ğŸ’° *é‡‘é¡*: HKD ${tx.amount.toLocaleString()}\n`;
        if(tx.currency && tx.currency !== 'HKD') msg += `ğŸ’± *å¤–å¹£*: ${tx.currency} ${tx.fxAmount.toLocaleString()}\n`;
        if(tx.type === 'expense') msg += `ğŸ’³ *å¡ç‰‡*: ${cardName}\n`;
        msg += `ğŸ“ *æè¿°*: ${tx.desc}\n`;
        msg += `ğŸ“‚ *é¡åˆ¥*: ${tx.category}\n`;
        msg += `ğŸ“… *æ™‚é–“*: ${dateStr}\n`;
        
        sendTGMessage(state.settings.tgToken, state.settings.tgChatId, msg);
    }
    
    async function sendTelegramReport() {
        if (!state.settings.tgToken) { alert('è«‹è¨­å®š TG'); return; }
        if(!confirm('ç™¼é€æœˆçµå–®ï¼Ÿ')) return;
        const monthInput = document.getElementById('analysis-month') ? document.getElementById('analysis-month').value : new Date().toISOString().slice(0, 7);
        // ... calculation logic similar to calculateStats ...
        let msg = `ğŸ“Š *æœˆçµå–® (${monthInput})* \n(è©³ç´°æ•¸æ“šè«‹è¦‹ App)`;
        sendTGMessage(state.settings.tgToken, state.settings.tgChatId, msg);
    }
    
    async function sendTradeReport() {
        if (!state.settings.tgToken) { alert('è«‹è¨­å®š TG'); return; }
        if(!confirm('ç™¼é€ç‚’è³£å ±å‘Šï¼Ÿ')) return;
        
        const monthInput = document.getElementById('analysis-month') ? document.getElementById('analysis-month').value : new Date().toISOString().slice(0, 7);
        
        // Group trades by Date -> Shop
        const reportData = {};
        let totalProfit = 0;
        
        const filterMonth = analysisMode === 'month' && document.getElementById('analysis-month') ? document.getElementById('analysis-month').value : new Date().toISOString().slice(0, 7);
        
        const soldTrades = state.trades.filter(t => t.status === 'sold' && t.date.startsWith(filterMonth));

        if (soldTrades.length === 0) { alert('æœ¬æœˆæš«ç„¡å·²è³£å‡ºçš„äº¤æ˜“'); return; }

        // Sort by Date Desc
        soldTrades.sort((a,b) => new Date(b.date) - new Date(a.date));

        soldTrades.forEach(t => {
            const dateStr = t.date.slice(0, 10);
            if (!reportData[dateStr]) reportData[dateStr] = {};
            
            const shop = t.shop || 'å…¶ä»–';
            if (!reportData[dateStr][shop]) reportData[dateStr][shop] = [];
            
            reportData[dateStr][shop].push(t);
            totalProfit += t.profit;
        });

        let msg = `ğŸ“Š *ç‚’è³£å ±å‘Š (${filterMonth})*\n`;
        msg += `ğŸ’° ç¸½åˆ©æ½¤: $${totalProfit.toLocaleString()}\n`;
        msg += `------------------\n`;

        for (const [date, shops] of Object.entries(reportData)) {
            msg += `ğŸ“… *${date}*\n`;
            for (const [shop, items] of Object.entries(shops)) {
                msg += `ğŸ¢ ${shop}\n`;
                
                // Aggregate items
                const itemSummary = {};
                items.forEach(t => {
                    const cond = t.condition === 'opened' ? 'é–‹å°' : 'åŸå°';
                    const model = t.model === 'Pro Max' ? 'å¤§' : (t.model === 'Pro' ? 'ç´°' : t.model);
                    const key = `${cond}${model}${t.color}${t.cap}`; // e.g. åŸå°å¤§æ©™256GB
                    
                    if (!itemSummary[key]) itemSummary[key] = { qty: 0, profit: 0 };
                    itemSummary[key].qty += t.qty;
                    itemSummary[key].profit += t.profit;
                });

                for (const [key, val] of Object.entries(itemSummary)) {
                    msg += `- ${key}: ${val.qty} (è³º$${val.profit})\n`;
                }
            }
            msg += `\n`;
        }

        sendTGMessage(state.settings.tgToken, state.settings.tgChatId, msg);
    }

    // Export/Import
    function exportData(type) {
        const str = type==='json' ? JSON.stringify(state) : 'Date,Desc,Amount\n'+state.transactions.map(t=>`${t.date},${t.desc},${t.amount}`).join('\n');
        const blob = new Blob([str], {type: type==='json'?'application/json':'text/csv'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.'+type; a.click();
    }
    function triggerImport() { document.getElementById('file-input').click(); }
    function importData(input) {
        const reader = new FileReader();
        reader.onload = e => { state = JSON.parse(e.target.result); saveData(); location.reload(); };
        reader.readAsText(input.files[0]);
    }
    function cleanDuplicateCards() {
        const names = new Set();
        state.cards = state.cards.filter(c => !names.has(c.name) && names.add(c.name));
        saveData(); render();
        alert('å·²æ¸…ç†');
    }

    // Init
    init();
</script>
</body>
</html>
