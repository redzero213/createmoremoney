<!DOCTYPE html>
<html lang="zh-HK" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e1e">
    <title>å›è´ˆå“¥ - æ™ºèƒ½ç°½è³¬ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #00d26a; --primary-dark: #00a855; --bg: #121212; --surface: #1e1e1e; --surface-hover: #2d2d2d; --text: #e0e0e0; --text-muted: #a0a0a0; --danger: #ff4d4d; --income: #4facfe; --repay: #ff9f43; --miles: #a29bfe; --mission: #f39c12; --welcome: #e84393; --sub: #e17055; --trade: #00cec9; --info: #0984e3; --telegram: #229ED9; --border: #333; --card-gradient: linear-gradient(135deg, #2c3e50, #000000); --shadow: 0 4px 6px rgba(0,0,0,0.3); --chart-text: #e0e0e0; }
        [data-theme="light"] { --primary: #00b85c; --primary-dark: #008f45; --bg: #f4f6f8; --surface: #ffffff; --surface-hover: #eef2f5; --text: #1a1a1a; --text-muted: #666666; --danger: #d93025; --income: #1a73e8; --repay: #e37400; --miles: #6c5ce7; --mission: #d35400; --welcome: #d63031; --sub: #d63031; --trade: #00b894; --info: #0984e3; --telegram: #229ED9; --border: #e0e0e0; --card-gradient: linear-gradient(135deg, #2c3e50, #4ca1af); --shadow: 0 2px 8px rgba(0,0,0,0.08); --chart-text: #333333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        header { background: var(--surface); padding: 12px 20px; padding-top: max(12px, env(safe-area-inset-top)); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .app-logo { font-size: 1.4rem; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .icon-btn { background: transparent; border: 1px solid transparent; color: var(--text); font-size: 1.1rem; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .icon-btn:hover { background: var(--surface-hover); border-color: var(--border); }
        .icon-btn:active { transform: scale(0.95); }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: max(80px, env(safe-area-inset-bottom)); }
        .panel { background: var(--surface); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: var(--surface-hover); padding: 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: var(--text); margin: 5px 0; word-break: break-word; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); }
        .profit-pos { color: var(--primary); } .profit-neg { color: var(--danger); }
        
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .item-main { flex: 1; }
        .item-title { font-weight: 500; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .item-sub { font-size: 0.8rem; color: var(--text-muted); }
        .item-amount { font-weight: bold; font-size: 1.1rem; text-align: right; margin-left: 10px; }
        .cat-tag, .shop-tag, .source-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--surface-hover); border: 1px solid var(--border); color: var(--text-muted); }
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .status-ordered { background: #f39c12; color: #000; } 
        .status-stock { background: #3498db; color: #fff; } 
        .status-sold { background: var(--primary); color: #fff; } 
        .status-cut { background: var(--danger); color: #fff; text-decoration: line-through; } 
        .cashback-tag { font-size: 0.75rem; color: var(--primary); background: rgba(0, 210, 106, 0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; }
        .repay-tag { font-size: 0.75rem; color: var(--repay); border: 1px solid var(--repay); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; }

        .form-group { margin-bottom: 15px; } 
        label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; outline: none; }
        input:focus, select:focus { border-color: var(--primary); }
        .row-group { display: flex; gap: 10px; } .row-group > div { flex: 1; }
        .type-toggle { display: flex; background: var(--bg); border-radius: 8px; padding: 4px; border: 1px solid var(--border); margin-bottom: 15px; }
        .type-option { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        .type-option.active.expense { background: rgba(255, 77, 77, 0.15); color: var(--danger); border: 1px solid var(--danger); }
        .type-option.active.income { background: rgba(79, 172, 254, 0.15); color: var(--income); border: 1px solid var(--income); }
        .type-option.active.repayment { background: rgba(255, 159, 67, 0.15); color: var(--repay); border: 1px solid var(--repay); }
        
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .grid-btn { padding: 5px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 0.8rem; text-align: center; display:flex; align-items:center; justify-content:center; flex-direction:column; min-height:55px; line-height: 1.2; overflow-wrap: break-word; }
        .grid-btn:active { background: var(--surface); transform: scale(0.98); }
        .grid-btn.selected { background: var(--trade); color: #000; border-color: var(--trade); font-weight: bold; }

        .btn { background: var(--primary); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; border-radius: 6px; background: var(--surface-hover); color: var(--text); border: 1px solid var(--border); cursor: pointer; }
        .btn-text { background: none; border: none; color: var(--text-muted); padding: 5px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; }
        
        .credit-card { background: var(--card-gradient); padding: 15px; border-radius: 10px; margin-bottom: 10px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); color: #fff; }
        .card-name { font-weight: bold; font-size: 1.1rem; color: #fff; }
        .card-info { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        
        .fab { position: fixed; bottom: max(20px, env(safe-area-inset-bottom) + 20px); right: 20px; background: var(--primary); color: #fff; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,210,106,0.4); cursor: pointer; border: none; z-index: 90; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--surface); width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; padding: 25px; border-radius: 16px; padding-bottom: 50px; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 10px; background: #cc4444; border: 2px solid #fff; color: #fff; width: 36px; height: 36px; border-radius: 50%; font-size: 1.4rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .close-modal:active { transform: scale(0.9); }
        
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; overflow-x: auto; white-space: nowrap; }
        .tab { flex: 1; padding: 10px; text-align: center; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; min-width: 80px; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .search-bar { width: 100%; padding: 10px; margin-bottom: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); outline: none; }
        .cat-list-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); }
        
        .phone-icon { width: 22px; height: 40px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); position: relative; margin-bottom: 3px; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .phone-icon::before { content: ''; position: absolute; top: 5px; left: 4px; width: 10px; height: 10px; background: rgba(0,0,0,0.4); border-radius: 3px; }
        .phone-icon.silver { background: linear-gradient(135deg, #e3e4e5 0%, #999 100%); }
        .phone-icon.orange { background: linear-gradient(135deg, #C5B4A3 0%, #8C7C6D 100%); }
        .phone-icon.blue { background: linear-gradient(135deg, #3B4C58 0%, #202b36 100%); }
        .section-title { font-size: 0.85rem; color: var(--text-muted); margin: 15px 0 5px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 2px; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 999; left: 50%; bottom: 80px; transform: translateX(-50%); border: 1px solid var(--primary); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 60px; opacity: 0;} }
    </style>
</head>
<body>

<header>
    <h1><span class="logo-icon">ğŸ’°</span> å›è´ˆå“¥</h1>
    <div class="header-actions">
        <button class="icon-btn" onclick="openModal('settings')" title="è¨­å®š">âš™ï¸</button>
        <button class="icon-btn" onclick="openModal('category')" title="è‡ªè¨‚é¡åˆ¥">ğŸ“‚</button>
        <button class="icon-btn" onclick="openModal('data')" title="å‚™ä»½èˆ‡åŒæ­¥">â˜ï¸</button>
        <button class="icon-btn" id="btn-theme" onclick="toggleTheme()" title="åˆ‡æ›æ¨¡å¼">â˜€ï¸</button>
    </div>
</header>

<div class="container">

    <div class="panel">
        <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="stat-card">
                <div class="stat-label">æœ¬æœˆæ”¯å‡º</div>
                <div class="stat-value" id="total-spent" style="color:var(--danger)">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ¬æœˆæ”¶å…¥</div>
                <div class="stat-value" id="total-income" style="color:var(--income)">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">é è¨ˆå›è´ˆ</div>
                <div class="stat-value" id="total-cashback" style="color:var(--primary)">$0</div>
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('transactions')">è³¬ç›®ç´€éŒ„</div>
        <div class="tab" onclick="switchTab('cards')">ä¿¡ç”¨å¡</div>
        <div class="tab" onclick="switchTab('trading')">ğŸ“± ç‚’è³£</div>
        <div class="tab" onclick="switchTab('analysis')">åˆ†æ</div>
    </div>

    <!-- Tab: Transactions -->
    <div id="tab-transactions" class="tab-content active">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">æœ€è¿‘è³¬ç›®</h2>
                <span class="stat-label" id="tx-count">0 ç­†</span>
            </div>
            <input type="text" id="search-tx" class="search-bar" placeholder="ğŸ” æœå°‹ç´€éŒ„ã€é¡åˆ¥æˆ–é‡‘é¡..." oninput="renderTransactions()">
            <div id="transaction-list"></div>
        </div>
    </div>

    <!-- Tab: Cards -->
    <div id="tab-cards" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">æˆ‘çš„å¡åŒ…</h2>
                <div style="display:flex; gap:8px;">
                     <button class="btn-small" onclick="importPresetCards()" style="background:rgba(0,210,106,0.1); border-color:var(--primary); color:var(--primary);">ğŸ“¥ åŒ¯å…¥æ¨è–¦ç¥å¡</button>
                    <button class="btn-small" onclick="openModal('card')">+ æ–°å¢</button>
                </div>
            </div>
            <div id="card-list"></div>
        </div>
    </div>

    <!-- Tab: Trading -->
    <div id="tab-trading" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0; font-size:1.1rem;">ğŸ“± iPhone 17 ç‚’è³£ç´€éŒ„</h2>
                <div style="display:flex; gap:8px;">
                    <button class="btn-small" onclick="sendTradeReport()" style="background:var(--telegram); color:white;">ğŸ“Š TGå ±æ•¸</button>
                    <button class="btn-small" onclick="openModal('trade')" style="background:var(--trade); border-color:var(--trade); color:#000;">+ æ–°å¢å…¥è²¨</button>
                </div>
            </div>
            <div class="stats-grid" style="margin-bottom:15px;">
                <div class="stat-card"><div class="stat-label">ä»Šæ—¥åˆ©æ½¤ (å·²è³£)</div><div class="stat-value" id="trade-today-profit" style="color:var(--primary)">$0</div></div>
                <div class="stat-card"><div class="stat-label">ä»Šæ—¥å…¥è²¨é‡</div><div class="stat-value" id="trade-today-vol" style="color:var(--text)">0 éƒ¨</div></div>
            </div>
            <input type="text" id="search-trade" class="search-bar" placeholder="ğŸ” æœå°‹åº—èˆ–ã€å‹è™Ÿæˆ–å–®è™Ÿ..." oninput="renderTrading()">
            <div id="trade-list"></div>
        </div>
    </div>

    <!-- Tab: Analysis -->
    <div id="tab-analysis" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">æœˆåº¦æ”¯å‡ºåˆ†æ</h2>
                <input type="month" id="analysis-month" style="width:auto; padding:5px;" onchange="renderCharts()">
            </div>
            <div style="margin-bottom:30px;">
                <div class="chart-container"><canvas id="chart-cards"></canvas></div>
            </div>
            <div>
                <div class="chart-container"><canvas id="chart-daily"></canvas></div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Copyright Â© Redezero | v1.80<br>
        <button onclick="rescueData()" style="background:transparent; border:none; color:var(--text-muted); font-size:0.7rem; margin-top:10px;">â›‘ï¸ æ•¸æ“šæ€¥æ•‘ / ä¸‹è¼‰å‚™ä»½</button>
    </div>
</div>

<button class="fab" onclick="openModal('transaction')">+</button>

<!-- Modal: Transaction -->
<div id="modal-transaction" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <h2 id="tx-modal-title">æ–°å¢ç´€éŒ„</h2>
        <div class="type-toggle">
            <div class="type-option active expense" id="type-expense" onclick="setTxType('expense')">ğŸ’¸ æ”¯å‡º</div>
            <div class="type-option" id="type-income" onclick="setTxType('income')">ğŸ’° æ”¶å…¥</div>
            <div class="type-option" id="type-repayment" onclick="setTxType('repayment')">ğŸ’³ é‚„æ¬¾</div>
        </div>
        <form id="tx-form" onsubmit="addTransaction(event)">
            <input type="hidden" id="tx-type" value="expense">
            <input type="hidden" id="tx-id">
            <div class="form-group"><label>é‡‘é¡ (HKD)</label><input type="number" id="tx-amount" step="0.1" required></div>
            <div class="form-group" id="group-category"><label>é¡åˆ¥</label><select id="tx-category" required></select></div>
            <div class="form-group" id="group-card">
                <label>é¸æ“‡ä¿¡ç”¨å¡</label><select id="tx-card"></select>
                <div id="card-hint" style="font-size:0.8rem; color:var(--primary); margin-top:5px; display:none;">å›è´ˆ: <span id="hint-rate"></span>%</div>
            </div>
            <div class="form-group"><label>æè¿°</label><input type="text" id="tx-desc" required></div>
            <div class="form-group"><label>æ—¥æœŸæ™‚é–“</label><input type="datetime-local" id="tx-date" required></div>
            <button type="submit" class="btn">è¨˜è³¬</button>
        </form>
    </div>
</div>

<!-- Modal: Trade (Restored) -->
<div id="modal-trade" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <h2>ğŸ“± ç‚’è³£ç´€éŒ„</h2>
        <form id="trade-form" onsubmit="addTrade(event)">
            <input type="hidden" id="trade-id">
            
            <div class="section-title">1. è¨‚å–®è³‡æ–™</div>
            <div class="row-group">
                <div class="form-group">
                    <label>è³¼å…¥ä¾†æº</label>
                    <select id="trade-source" onchange="toggleCustomInput('source')" required></select>
                    <input type="text" id="trade-source-custom" placeholder="è«‹è¼¸å…¥ä¾†æº" style="display:none; margin-top:5px;">
                </div>
                <div class="form-group"><label>å–®è™Ÿ (é¸å¡«)</label><input type="text" id="trade-oid" placeholder="W123..."></div>
            </div>
            
            <div class="section-title">2. äº¤æ˜“ç‹€æ…‹</div>
            <div class="form-group">
                <div class="btn-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="grid-btn selected" onclick="selectTradeOption('status', 'pending', this)">ğŸ›’ å·²è¨‚</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'stock', this)">ğŸ“¦ ç¾è²¨</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'sold', this)">ğŸ’° å·²è³£</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'cut', this)">âŒ Cutå–®</div>
                </div>
                <input type="hidden" id="trade-status" value="pending" required>
            </div>

            <div class="section-title">3. å›æ”¶åº—èˆ– (å¦‚å·²è³£å‡º)</div>
            <div class="form-group">
                <select id="trade-shop" onchange="toggleCustomInput('shop')"></select>
                <input type="text" id="trade-shop-custom" placeholder="è«‹è¼¸å…¥åº—èˆ–åç¨±" style="display:none; margin-top:5px;">
            </div>

            <div class="section-title">4. è¦æ ¼ & è²¡å‹™</div>
            <div class="form-group"><label>å‹è™Ÿ</label>
                <div class="btn-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="grid-btn" onclick="selectTradeOption('model', 'Pro', this)">Pro</div>
                    <div class="grid-btn" onclick="selectTradeOption('model', 'Pro Max', this)">Pro Max</div>
                </div><input type="hidden" id="trade-model" required>
            </div>
            <div class="form-group"><label>å®¹é‡</label>
                <div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="grid-btn" onclick="selectTradeOption('cap', '256GB', this)">256GB</div>
                    <div class="grid-btn" onclick="selectTradeOption('cap', '512GB', this)">512GB</div>
                    <div class="grid-btn" onclick="selectTradeOption('cap', '1TB', this)">1TB</div>
                </div><input type="hidden" id="trade-cap" required>
            </div>
            <div class="form-group"><label>é¡è‰²</label>
                <div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="grid-btn" onclick="selectTradeOption('color', 'éŠ€', this)"><div class="phone-icon silver"></div>éŠ€</div>
                    <div class="grid-btn" onclick="selectTradeOption('color', 'æ©™', this)"><div class="phone-icon orange"></div>æ©™</div>
                    <div class="grid-btn" onclick="selectTradeOption('color', 'è—', this)"><div class="phone-icon blue"></div>è—</div>
                </div><input type="hidden" id="trade-color" required>
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <label>ç‹€æ…‹:</label>
                <div class="btn-grid" style="grid-template-columns: 1fr 1fr; width:100%; margin:0;">
                    <div class="grid-btn selected" onclick="selectTradeOption('condition', 'sealed', this)">ğŸ”’ åŸå°</div>
                    <div class="grid-btn" onclick="selectTradeOption('condition', 'opened', this)">ğŸ”ª é–‹å°</div>
                </div>
                <input type="hidden" id="trade-condition" value="sealed">
            </div>

            <div class="row-group">
                <div class="form-group"><label>åŸåƒ¹/æˆæœ¬</label><input type="number" id="trade-cost" required></div>
                <div class="form-group"><label>æ”¾å”®åƒ¹</label><input type="number" id="trade-price" value="0" required></div>
            </div>
            <div class="row-group">
                <div class="form-group"><label>æ•¸é‡</label><input type="number" id="trade-qty" value="1" min="1" required></div>
                <div class="form-group">
                    <label>ä»˜æ¬¾ä¿¡ç”¨å¡</label>
                    <select id="trade-card"><option value="">ç„¡ä½¿ç”¨ä¿¡ç”¨å¡</option></select>
                </div>
            </div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="datetime-local" id="trade-date" required></div>
            <button type="submit" class="btn" style="background:var(--trade); color:#000;">å„²å­˜äº¤æ˜“</button>
        </form>
    </div>
</div>

<!-- Modal: Category (Custom Categories) -->
<div id="modal-category" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <h2 style="margin-top:0;">ğŸ“‚ è‡ªè¨‚æ”¶æ”¯é¡åˆ¥</h2>
        <div class="type-toggle">
            <div class="type-option active expense" id="cat-type-expense" onclick="switchCatType('expense')">æ”¯å‡ºé¡åˆ¥</div>
            <div class="type-option" id="cat-type-income" onclick="switchCatType('income')">æ”¶å…¥é¡åˆ¥</div>
        </div>
        <div id="category-list" style="margin-bottom:15px; max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px;"></div>
        <form onsubmit="addCategory(event)">
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-category-name" placeholder="è¼¸å…¥æ–°é¡åˆ¥åç¨±" required style="flex:1;">
                <button type="submit" class="btn-small" style="background:var(--primary); color:#fff;">æ–°å¢</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Settings (TG Notification Setup) -->
<div id="modal-settings" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="form-group">
            <label>Telegram Bot Token</label>
            <input type="password" id="tg-token" placeholder="123456:ABC-DEF..." onchange="saveTGSettings()">
        </div>
        <div class="form-group">
            <label>Telegram Chat ID</label>
            <input type="text" id="tg-chatid" placeholder="123456789" onchange="saveTGSettings()">
        </div>
        <div class="form-group" style="display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="setting-tg-auto" style="width:20px;height:20px;" onchange="saveTGSettings()">
            <label style="margin:0;">é–‹å•Ÿè‡ªå‹• TG è¨˜å¸³åŠçˆ†é¡é€šçŸ¥</label>
        </div>
        <button class="btn-small" onclick="testTG()" style="width:100%; margin-top:10px;">æ¸¬è©¦ç™¼é€ TG</button>
    </div>
</div>

<!-- Modal: Card -->
<div id="modal-card" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <h2>æ–°å¢ä¿¡ç”¨å¡</h2>
        <form id="card-form" onsubmit="addCard(event)">
            <div class="form-group"><label>å¡ç‰‡åç¨±</label><input type="text" id="card-name" required></div>
            <div class="form-group"><label>å›è´ˆæ¯”ç‡ (%)</label><input type="number" id="card-percent" step="0.1" required></div>
            <div class="form-group"><label>ç°½è³¬ä¸Šé™ (ç•™ç©ºç‚ºç„¡é™)</label><input type="number" id="card-cap"></div>
            <div class="form-group"><label>å‚™è¨»</label><input type="text" id="card-note"></div>
            <button type="submit" class="btn">æ–°å¢å¡ç‰‡</button>
        </form>
    </div>
</div>

<!-- Modal: Data Management -->
<div id="modal-data" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">&times;</button>
        <h2 style="margin-top:0;">â˜ï¸ å‚™ä»½èˆ‡åŒæ­¥</h2>
        <button class="btn" style="background:#ff9f43; margin-bottom:10px;" onclick="exportData('json')">ğŸ’¾ ä¸‹è¼‰å‚™ä»½æª” (JSON)</button>
        <button class="btn" style="background:#333; border:1px solid #666; margin-bottom:10px;" onclick="triggerImport()">ğŸ“‚ é‚„åŸå‚™ä»½æª”</button>
        <input type="file" id="file-input" style="display:none;" accept=".json" onchange="importData(this)">
        <button class="btn-small" onclick="resetData()" style="color:var(--danger); border-color:var(--danger); width:100%; margin-top:20px;">ğŸ”¥ æ¸…é™¤æ‰€æœ‰è³‡æ–™ (é‡ç½®)</button>
    </div>
</div>

<div id="toast"></div>

<script>
    // --- Global Error Catcher ---
    window.onerror = function(msg, url, line) {
        const div = document.getElementById('error-console');
        if(div) { div.style.display = 'block'; div.innerHTML += `ğŸ”´ Error: ${msg} <br>Line: ${line}<br>`; }
        return false;
    };

    // --- Configuration ---
    const DB_KEY = 'rebate_bro_data_v2';
    const THEME_KEY = 'rebate_bro_theme';
    
    const TRADE_SOURCES = ['AOS (å®˜ç¶²)', 'APU (åº—å–)', 'ç™¾è€åŒ¯', 'è±æ¾¤', 'å‹å’Œ', 'è˜‡å¯§', 'é›»å™¨å¹«', 'CMHK', 'CSL', 'Smartone', '3HK', 'ä¸­åŸ', '1010'];
    const TRADE_SHOPS = ['é›ªçƒ', 'è¬é€š', 'æ—¥éŸ“', 'èª ä¿¡', 'bobo', 'YY', 'G79', 'F9', 'DIY', 'æ–°å®‡å®™', 'æº«è¨˜', 'éµ¬ç¨‹', 'iTrade', 'æ˜Ÿè€€', 'Carousell'];
    const IPHONE_PRICES = { 'Pro': { '256GB': 9399, '512GB': 11099, '1TB': 12799 }, 'Pro Max': { '256GB': 10199, '512GB': 11899, '1TB': 13599, '2TB': 16999 } };
    
    const DEFAULT_CATEGORIES = { 
        expense: ['é£Ÿé£¯', 'å…«é”é€šå¢å€¼', 'è³¼ç‰©', 'å¨›æ¨‚', 'é›œè²»', 'å…¶ä»–', 'å›ºå®šé–‹æ”¯'], 
        income: ['è–ªé‡‘', 'è³£é‡', 'æŠ•è³‡', 'å…¶ä»–'], 
        repayment: ['ä¿¡ç”¨å¡é‚„æ¬¾'] 
    };

    const PRESET_CARDS = [ 
        { name: 'ç¾é‡‘', percent: 0, cap: 0, note: '' }, 
        { name: 'ä¿¡éŠ€ Motion', percent: 6, cap: 3600, note: 'é¤é£²/ç¶²è³¼6%' },
        { name: 'AEON WAKUWAKU', percent: 6, cap: 5000, note: 'ç¶²è³¼6%' },
        { name: 'æ’ç”Ÿ MMPOWER', percent: 5, cap: 10000, note: 'è‡ªé¸é¡åˆ¥5%' },
        { name: 'ä¸­éŠ€ Chill', percent: 5, cap: 3260, note: 'å½±è¦–/å¿«é¤5%' },
        { name: 'æ»™è± Red å¡', percent: 4, cap: 12500, note: 'ç¶²è³¼4%' },
        { name: 'å¯Œé‚¦ iN Visa', percent: 8, cap: 3750, note: 'æŒ‡å®šé¡åˆ¥8%' },
        { name: 'å®‰ä¿¡ EarnMORE', percent: 2, cap: 150000, note: 'å…¨åŸ2%' }
    ];

    let state = { transactions: [], cards: [], trades: [], categories: null, settings: {} };
    let pieChart = null, barChart = null, currentCatEditType = 'expense';

    // --- Core Initialization ---
    function init() {
        try {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) {
                state = JSON.parse(stored);
            }
            // Defensive setup for missing keys
            if(!state.transactions) state.transactions = [];
            if(!state.cards) state.cards = [];
            if(!state.trades) state.trades = [];
            if(!state.settings) state.settings = { tgAutoSend: false };
            if(!state.categories) state.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));

            // Populate Trade Selects
            const sourceS = document.getElementById('trade-source');
            if(sourceS) { 
                sourceS.innerHTML = '<option value="">-- é¸æ“‡ä¾†æº --</option>';
                TRADE_SOURCES.forEach(src => sourceS.add(new Option(src, src)));
                sourceS.add(new Option('å…¶ä»– (æ‰‹å‹•è¼¸å…¥)', 'other'));
            }
            const shopS = document.getElementById('trade-shop');
            if(shopS) { 
                shopS.innerHTML = '<option value="">-- è«‹é¸æ“‡ (æœªè³£å‡ºå¯ä¸å¡«) --</option>';
                TRADE_SHOPS.forEach(sh => shopS.add(new Option(sh, sh)));
                shopS.add(new Option('å…¶ä»– (æ‰‹å‹•è¼¸å…¥)', 'other'));
            }

            // Restore Settings
            if(document.getElementById('tg-token')) document.getElementById('tg-token').value = state.settings.tgToken || '';
            if(document.getElementById('tg-chatid')) document.getElementById('tg-chatid').value = state.settings.tgChatId || '';
            if(document.getElementById('setting-tg-auto')) document.getElementById('setting-tg-auto').checked = state.settings.tgAutoSend || false;

            applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
            setDefaultTime();
            document.getElementById('analysis-month').value = new Date().toISOString().slice(0, 7);
            
            render();
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('new_tx') === 'true') openModal('transaction');

        } catch (err) { alert("å•Ÿå‹•éŒ¯èª¤: " + err.message); }
    }

    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = 'show'; setTimeout(()=>t.className='', 2500); }

    // --- Rendering ---
    function render() {
        renderCards();
        renderTransactions();
        renderTrading();
        updateFormOptions();
        calculateStats();
        if (document.getElementById('tab-analysis').classList.contains('active')) renderCharts();
    }

    function renderCards() {
        const l = document.getElementById('card-list'); l.innerHTML = '';
        state.cards.forEach(card => {
            const capText = card.cap > 0 ? ` / $${card.cap.toLocaleString()}` : '';
            l.innerHTML += `
                <div class="credit-card">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div><div class="card-name">${card.name}</div><div class="card-info" style="color:var(--primary);">${card.percent}% å›è´ˆ</div></div>
                        <button class="btn-text" onclick="deleteCard(${card.id})" style="color:#fff;">&times;</button>
                    </div>
                    <div class="progress-bar"><div id="prog-${card.id}" class="progress-fill"></div></div>
                    <div class="card-info"><span>æœ¬æœˆå·²ç°½: <span id="spent-${card.id}">$0</span>${capText}</span></div>
                </div>`;
        });
    }

    function renderTransactions() {
        const l = document.getElementById('transaction-list'); l.innerHTML = '';
        let sorted = [...state.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
        
        const q = document.getElementById('search-tx') ? document.getElementById('search-tx').value.toLowerCase() : '';
        if(q) sorted = sorted.filter(tx => (tx.desc||'').toLowerCase().includes(q) || (tx.category||'').toLowerCase().includes(q));

        if(sorted.length === 0) l.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">ç„¡ç´€éŒ„</div>';
        
        sorted.forEach(tx => {
            const card = state.cards.find(c => c.id == tx.cardId);
            const cName = card ? card.name : 'æœªçŸ¥å¡ç‰‡';
            const color = tx.type === 'income' ? 'var(--income)' : (tx.type === 'repayment' ? 'var(--repay)' : 'var(--text)');
            const sign = tx.type === 'income' ? '+' : (tx.type === 'repayment' ? '-' : '');
            l.innerHTML += `
                <div class="list-item">
                    <div class="item-main">
                        <div class="item-title"><span class="cat-tag">${tx.category}</span> ${tx.desc}</div>
                        <div class="item-sub">${tx.date.replace('T', ' ')} â€¢ ${cName}</div>
                    </div>
                    <div style="text-align:right">
                        <div class="item-amount" style="color:${color}">${sign}$${tx.amount}</div>
                        <button class="btn-text" style="font-size:0.75rem;" onclick="deleteTransaction(${tx.id})">åˆªé™¤</button>
                    </div>
                </div>`;
        });
    }

    function renderTrading() {
        const l = document.getElementById('trade-list'); l.innerHTML = '';
        if(!state.trades) state.trades = [];
        let sortedTrades = [...state.trades].sort((a,b) => new Date(b.date) - new Date(a.date));
        
        const q = document.getElementById('search-trade') ? document.getElementById('search-trade').value.toLowerCase() : '';
        if(q) sortedTrades = sortedTrades.filter(t => (t.model||'').toLowerCase().includes(q) || (t.shop||'').toLowerCase().includes(q) || (t.oid||'').toLowerCase().includes(q));

        let todayProfit = 0, todayVol = 0;
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const todayStr = now.toISOString().slice(0, 10);

        sortedTrades.forEach(t => {
            // Stats calculation for "Today"
            if (t.date.slice(0, 10) === todayStr) {
                if (t.status !== 'cut') todayVol += parseInt(t.qty);
                if (t.status === 'sold') todayProfit += parseFloat(t.profit);
            }

            // UI Generation
            let statusBadge = '';
            let profitDisplay = '';
            if (t.status === 'pending') statusBadge = '<span class="status-badge status-ordered">ğŸ›’ å·²è¨‚</span>';
            else if (t.status === 'stock') statusBadge = '<span class="status-badge status-stock">ğŸ“¦ ç¾è²¨</span>';
            else if (t.status === 'cut') statusBadge = '<span class="status-badge status-cut">âŒ Cutå–®</span>';
            else {
                statusBadge = '<span class="status-badge status-sold">ğŸ’° å·²è³£</span>';
                if(t.condition === 'opened') statusBadge += 'ğŸ”ª';
                const pClass = t.profit >= 0 ? 'profit-pos' : 'profit-neg';
                profitDisplay = `<span class="${pClass}">$${t.profit}</span>`;
            }
            
            const oidText = t.oid ? `(å–®è™Ÿ:${t.oid})` : '';
            const locationDisplay = (t.status === 'sold' && t.shop) ? `${t.source} ${oidText} â” ${t.shop}` : `${t.source} ${oidText}`;
            const card = state.cards.find(c => c.id == t.cardId);
            const cName = card ? `<span class="cat-tag">ğŸ’³ ${card.name}</span>` : '';
            
            l.innerHTML += `
                <div class="list-item">
                    <div class="item-main">
                        <div class="item-title">${statusBadge} ${t.model} ${t.cap}</div>
                        <div class="item-sub">${locationDisplay} â€¢ ${t.date.slice(0,10)} ${cName}</div>
                    </div>
                    <div style="text-align:right">
                        <div class="item-amount" style="font-size:0.9rem;">x${t.qty} ${profitDisplay}</div>
                        <div style="display:flex; justify-content:flex-end;">
                            <button class="btn-text" onclick="cloneTrade(${t.id})" title="è¤‡è£½æ­¤å–®">ğŸ“‹</button>
                            <button class="btn-text" onclick="editTrade(${t.id})">âœ</button>
                            <button class="btn-text" onclick="deleteTrade(${t.id})">X</button>
                        </div>
                    </div>
                </div>`;
        });
        
        document.getElementById('trade-today-profit').innerText = '$' + todayProfit.toLocaleString();
        document.getElementById('trade-today-vol').innerText = todayVol + ' éƒ¨';
    }

    function calculateStats() {
        let totalSpent=0, totalInc=0, totalRepay=0, totalCash=0;
        const cardSpent = {};
        state.cards.forEach(c => cardSpent[c.id]=0);
        const nowMonth = new Date().toISOString().slice(0, 7);

        state.transactions.forEach(tx => {
            if(tx.date.startsWith(nowMonth)) {
                if(tx.type==='expense') {
                    totalSpent += tx.amount;
                    if(tx.cardId) {
                        cardSpent[tx.cardId] += tx.amount;
                        const c = state.cards.find(x=>x.id==tx.cardId);
                        if(c) totalCash += (tx.amount * c.percent / 100);
                    }
                } else if(tx.type==='income') totalInc += tx.amount;
                else if(tx.type==='repayment') totalRepay += tx.amount;
            }
        });

        // Add Trading costs to card spent calculation
        state.trades.forEach(t => {
            if(t.date.startsWith(nowMonth) && t.cardId && t.status !== 'cut') {
                const cst = (t.cost * t.qty);
                cardSpent[t.cardId] += cst;
                const c = state.cards.find(x=>x.id==t.cardId);
                if(c) totalCash += (cst * c.percent / 100);
            }
        });

        document.getElementById('total-spent').innerText = '$'+totalSpent.toLocaleString();
        document.getElementById('total-income').innerText = '$'+totalInc.toLocaleString();
        document.getElementById('total-repaid').innerText = '$'+totalRepay.toLocaleString();
        document.getElementById('total-cashback').innerText = '$'+totalCash.toFixed(1);
        if(document.getElementById('tx-count')) document.getElementById('tx-count').innerText = state.transactions.length + ' ç­†';

        state.cards.forEach(c => {
             const s = cardSpent[c.id] || 0;
             const elS = document.getElementById('spent-'+c.id); if(elS) elS.innerText = '$'+s.toLocaleString();
             const elBar = document.getElementById('prog-'+c.id); 
             if(elBar && c.cap > 0) {
                 const pct = Math.min((s/c.cap)*100, 100);
                 elBar.style.width = pct+'%';
                 elBar.style.backgroundColor = pct>=100 ? 'var(--danger)' : 'var(--primary)';
             }
        });
    }

    // --- Trading Logic ---
    function selectTradeOption(type, val, el) {
        document.getElementById('trade-'+type).value = val;
        const grid = el.parentElement;
        Array.from(grid.children).forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        
        // Auto Cost
        if(type==='model' || type==='cap') {
            const m = document.getElementById('trade-model').value;
            const c = document.getElementById('trade-cap').value;
            if(m && c && IPHONE_PRICES[m] && IPHONE_PRICES[m][c]) document.getElementById('trade-cost').value = IPHONE_PRICES[m][c];
        }
    }
    
    function toggleCustomInput(type) {
        const sel = document.getElementById('trade-'+type);
        const inp = document.getElementById('trade-'+type+'-custom');
        if(sel.value === 'other') { inp.style.display = 'block'; inp.required = true; } 
        else { inp.style.display = 'none'; inp.required = false; }
    }

    function addTrade(e) {
        e.preventDefault();
        try {
            const idStr = document.getElementById('trade-id').value;
            const cost = parseFloat(document.getElementById('trade-cost').value) || 0;
            const price = parseFloat(document.getElementById('trade-price').value) || 0;
            const qty = parseInt(document.getElementById('trade-qty').value) || 1;
            const cid = document.getElementById('trade-card').value;
            
            let source = document.getElementById('trade-source').value;
            if(source === 'other') source = document.getElementById('trade-source-custom').value;
            
            let shop = document.getElementById('trade-shop').value;
            if(shop === 'other') shop = document.getElementById('trade-shop-custom').value;

            const tData = {
                source, shop, oid: document.getElementById('trade-oid').value || '',
                model: document.getElementById('trade-model').value,
                cap: document.getElementById('trade-cap').value,
                color: document.getElementById('trade-color').value,
                status: document.getElementById('trade-status').value,
                condition: document.getElementById('trade-condition').value,
                cost, price, qty, profit: (price-cost)*qty,
                cardId: cid, date: document.getElementById('trade-date').value
            };

            if (idStr) {
                tData.id = parseFloat(idStr);
                const idx = state.trades.findIndex(t => t.id === tData.id);
                if (idx !== -1) state.trades[idx] = tData;
            } else {
                tData.id = Date.now();
                state.trades.unshift(tData);
                if(state.settings.tgAutoSend) sendTelegramTradeAlert(tData);
            }
            saveData(); render(); closeModals(); showToast('âœ… äº¤æ˜“å·²å„²å­˜');
        } catch(err) { alert("å„²å­˜å¤±æ•—: " + err.message); }
    }

    function cloneTrade(id) {
        editTrade(id); 
        document.getElementById('trade-id').value = '';
        document.getElementById('trade-oid').value = '';
        setDefaultTime();
        showToast('ğŸ“‹ å·²è¤‡è£½ï¼è«‹ä¿®æ”¹å¾ŒæŒ‰å„²å­˜');
    }

    function editTrade(id) {
        const t = state.trades.find(x => x.id === id);
        if (!t) return;
        openModal('trade');
        document.getElementById('trade-id').value = t.id;
        
        // Source
        const srcS = document.getElementById('trade-source');
        if([...srcS.options].some(o=>o.value===t.source)) { srcS.value=t.source; document.getElementById('trade-source-custom').style.display='none'; }
        else { srcS.value='other'; document.getElementById('trade-source-custom').style.display='block'; document.getElementById('trade-source-custom').value=t.source; }
        
        // Shop
        const shpS = document.getElementById('trade-shop');
        if([...shpS.options].some(o=>o.value===t.shop) || !t.shop) { shpS.value=t.shop||""; document.getElementById('trade-shop-custom').style.display='none'; }
        else { shpS.value='other'; document.getElementById('trade-shop-custom').style.display='block'; document.getElementById('trade-shop-custom').value=t.shop; }

        document.getElementById('trade-oid').value = t.oid || "";
        document.getElementById('trade-cost').value = t.cost;
        document.getElementById('trade-price').value = t.price;
        document.getElementById('trade-qty').value = t.qty;
        document.getElementById('trade-card').value = t.cardId || "";
        document.getElementById('trade-date').value = t.date.slice(0,16);

        // Update Grids
        ['model', 'cap', 'color', 'status', 'condition'].forEach(type => {
            const val = t[type];
            const input = document.getElementById('trade-'+type);
            if(input) {
                input.value = val;
                const grid = input.parentElement.querySelector('.btn-grid') || input.parentElement.parentElement.querySelector('.btn-grid');
                if(grid) {
                    Array.from(grid.children).forEach(b => {
                        b.classList.remove('selected');
                        if(b.innerText.includes(val) || b.innerText===val) b.classList.add('selected');
                    });
                }
            }
        });
    }

    function deleteTrade(id) { if(confirm('åˆªé™¤äº¤æ˜“?')) { state.trades = state.trades.filter(t=>t.id!==id); saveData(); render(); } }

    // --- TG Notifications ---
    function saveTGSettings() {
        state.settings.tgToken = document.getElementById('tg-token').value;
        state.settings.tgChatId = document.getElementById('tg-chatid').value;
        state.settings.tgAutoSend = document.getElementById('setting-tg-auto').checked;
        saveData(); showToast('âœ… è¨­å®šå·²å„²å­˜');
    }

    async function sendTGMessage(t, cid, msg) {
        if (!t || !cid) return;
        try { 
            await fetch(`https://api.telegram.org/bot${t}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({chat_id:cid, text:msg, parse_mode:'Markdown'}) });
        } catch(e) { console.error(e); }
    }

    function sendTelegramTradeAlert(t) {
        if(!state.settings.tgToken || !state.settings.tgChatId) return;
        let cText = "ç„¡ä½¿ç”¨ä¿¡ç”¨å¡", cLimit = "";
        
        if (t.cardId) {
            const card = state.cards.find(c => c.id == t.cardId);
            if (card) {
                cText = card.name;
                let spent = 0; const nowMonth = new Date().toISOString().slice(0, 7);
                state.transactions.forEach(tx => { if(tx.date.startsWith(nowMonth) && tx.cardId == card.id && tx.type === 'expense') spent += tx.amount; });
                state.trades.forEach(tr => { if(tr.date.startsWith(nowMonth) && tr.cardId == card.id && tr.status!=='cut') spent += (tr.cost * tr.qty); });
                
                cLimit = `\nğŸ“Š *æœ¬æœˆç´¯ç©*: $${spent.toLocaleString()}`;
                if (card.cap > 0) {
                    cLimit += ` / $${card.cap.toLocaleString()} (${Math.round((spent/card.cap)*100)}%)`;
                    if (spent >= card.cap) cLimit += `\nâš ï¸ *è­¦å‘Šï¼šå·²çˆ†é¡ï¼* ğŸš¨`;
                }
            }
        }

        const mStr = t.model === 'Pro Max' ? 'å¤§' : (t.model === 'Pro' ? 'ç´°' : t.model);
        const cStr = t.condition === 'opened' ? 'é–‹å°' : 'åŸå°';
        let msg = `ğŸ“± *æ–°ç‚’è³£ç´€éŒ„*\nğŸ›’ ä¾†æº: ${t.source}${t.oid?` (å–®è™Ÿ:${t.oid})`:''}\nğŸ“¦ è¦æ ¼: ${cStr}${mStr}${t.color}${t.cap} x${t.qty}\nğŸ’° ç¸½æˆæœ¬: $${(t.cost * t.qty).toLocaleString()}\n`;
        if (t.status === 'sold') msg += `ğŸ¤ å›æ”¶: ${t.shop} (è³£$${t.price})\nğŸ“ˆ åˆ©æ½¤: $${t.profit.toLocaleString()}\n`;
        else msg += `ğŸ“Œ ç‹€æ…‹: ${{'pending':'å·²è¨‚æœªå–','stock':'ç¾è²¨åœ¨æ‰‹'}[t.status]||t.status}\n`;
        msg += `ğŸ’³ å¡ç‰‡: ${cText}${cLimit}`;
        
        sendTGMessage(state.settings.tgToken, state.settings.tgChatId, msg);
    }
    
    function sendTradeReport() {
        if (!state.settings.tgToken) { alert('è«‹å…ˆè¨­å®š TG Token'); return; }
        const filterMonth = document.getElementById('analysis-month') ? document.getElementById('analysis-month').value : new Date().toISOString().slice(0, 7);
        const sold = state.trades.filter(t => t.status === 'sold' && t.date.startsWith(filterMonth));
        if (sold.length === 0) { alert('æœ¬æœˆæš«ç„¡å·²è³£å‡ºçš„äº¤æ˜“'); return; }

        sold.sort((a,b) => new Date(b.date) - new Date(a.date));
        const rep = {}; let tot = 0;
        sold.forEach(t => {
            const d = t.date.slice(0, 10);
            if(!rep[d]) rep[d] = {};
            if(!rep[d][t.shop||'å…¶ä»–']) rep[d][t.shop||'å…¶ä»–'] = [];
            rep[d][t.shop||'å…¶ä»–'].push(t);
            tot += t.profit;
        });

        let msg = `ğŸ“Š *ç‚’è³£å ±å‘Š (${filterMonth})*\nğŸ’° ç¸½åˆ©æ½¤: $${tot.toLocaleString()}\n------------------\n`;
        for (const [date, shops] of Object.entries(rep)) {
            msg += `ğŸ“… *${date}*\n`;
            for (const [shop, items] of Object.entries(shops)) {
                msg += `ğŸ¢ ${shop}\n`;
                const sum = {};
                items.forEach(t => {
                    const key = `${t.condition==='opened'?'é–‹å°':'åŸå°'}${t.model==='Pro Max'?'å¤§':'ç´°'}${t.color}${t.cap}`;
                    if(!sum[key]) sum[key] = {q:0, p:0};
                    sum[key].q += t.qty; sum[key].p += t.profit;
                });
                for (const [k, v] of Object.entries(sum)) msg += `- ${k}: ${v.q} (è³º$${v.p})\n`;
            } msg += `\n`;
        }
        sendTGMessage(state.settings.tgToken, state.settings.tgChatId, msg);
        showToast('âœ… å ±å‘Šå·²ç™¼é€è‡³ TG');
    }

    // --- Other Core Functions (Categories, Tx, etc.) ---
    function openModal(type) {
        document.getElementById('modal-'+type).classList.add('active');
        if(type==='transaction') { document.getElementById('tx-form').reset(); document.getElementById('tx-id').value=''; setTxType('expense'); setDefaultTime(); }
        if(type==='trade' && !document.getElementById('trade-id').value) {
            document.getElementById('trade-form').reset(); document.getElementById('trade-id').value='';
            document.getElementById('trade-source-custom').style.display='none'; document.getElementById('trade-shop-custom').style.display='none';
            document.querySelectorAll('.grid-btn.selected').forEach(b=>b.classList.remove('selected'));
            setDefaultTime(); updateFormOptions();
        }
        if(type==='category') renderCategories();
    }
    
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); document.getElementById('trade-id').value = ''; }
    function openMenuTarget(t) { closeModals(); setTimeout(()=>openModal(t), 50); }

    function setTxType(t) {
        document.getElementById('tx-type').value=t;
        document.querySelectorAll('.type-option').forEach(e=>e.classList.remove('active','expense','income','repayment'));
        document.getElementById('type-'+t).classList.add('active', t);
        const catS = document.getElementById('tx-category'); catS.innerHTML='';
        (state.categories[t] || DEFAULT_CATEGORIES[t]).forEach(c=>catS.add(new Option(c,c)));
        document.getElementById('group-card').style.display = t==='income'?'none':'block';
        updateCardHint();
    }

    function switchCatType(t) {
        currentCatEditType = t;
        document.getElementById('cat-type-expense').classList.remove('active', 'expense');
        document.getElementById('cat-type-income').classList.remove('active', 'income');
        document.getElementById('cat-type-'+t).classList.add('active', t);
        renderCategories();
    }

    function renderCategories() {
        const l = document.getElementById('category-list'); l.innerHTML = '';
        (state.categories[currentCatEditType]||[]).forEach((c, idx) => {
            l.innerHTML += `<div class="cat-list-item"><span>${c}</span><button class="btn-text" style="color:var(--danger)" onclick="deleteCategory('${currentCatEditType}', ${idx})">X</button></div>`;
        });
    }

    function addCategory(e) {
        e.preventDefault();
        const v = document.getElementById('new-category-name').value.trim();
        if(v && !state.categories[currentCatEditType].includes(v)) {
            state.categories[currentCatEditType].push(v); saveData(); renderCategories();
            document.getElementById('new-category-name').value = '';
            if(document.getElementById('tx-type').value === currentCatEditType) setTxType(currentCatEditType);
        }
    }
    function deleteCategory(type, idx) { state.categories[type].splice(idx, 1); saveData(); renderCategories(); if(document.getElementById('tx-type').value === type) setTxType(type); }

    function updateCardHint() {
        const cid = document.getElementById('tx-card').value;
        const c = state.cards.find(x=>x.id==cid);
        const h = document.getElementById('card-hint');
        if(c && document.getElementById('tx-type').value==='expense') { h.style.display='block'; document.getElementById('hint-rate').innerText = c.percent; } 
        else h.style.display='none';
    }
    
    function updateFormOptions() {
        const s = document.getElementById('tx-card'); s.innerHTML='';
        const ts = document.getElementById('trade-card'); if(ts) ts.innerHTML='<option value="">ç„¡ä½¿ç”¨ä¿¡ç”¨å¡</option>';
        state.cards.forEach(c => { s.add(new Option(c.name, c.id)); if(ts) ts.add(new Option(c.name, c.id)); });
        updateCardHint();
    }

    function switchTab(name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if(name==='transactions') { document.querySelectorAll('.tab')[0].classList.add('active'); document.getElementById('tab-transactions').classList.add('active'); }
        else if(name==='cards') { document.querySelectorAll('.tab')[1].classList.add('active'); document.getElementById('tab-cards').classList.add('active'); }
        else if(name==='trading') { document.querySelectorAll('.tab')[2].classList.add('active'); document.getElementById('tab-trading').classList.add('active'); renderTrading(); }
        else if(name==='analysis') { document.querySelectorAll('.tab')[3].classList.add('active'); document.getElementById('tab-analysis').classList.add('active'); renderCharts(); }
    }

    // --- Charts ---
    function renderCharts() {
        if(!document.getElementById('chart-cards')) return;
        const style = getComputedStyle(document.body); const textColor = style.getPropertyValue('--chart-text').trim();
        const colors = ['#00d26a', '#4facfe', '#ff6b6b', '#fca5a5', '#ffd93d', '#a855f7'];
        const m = document.getElementById('analysis-month').value; if(!m) return;
        
        let txs = state.transactions.filter(tx => tx.date.startsWith(m) && tx.type === 'expense');
        
        const cardTotals = {}; state.cards.forEach(c => cardTotals[c.name] = 0); 
        txs.forEach(tx => { const card = state.cards.find(c => c.id == tx.cardId); if(card) cardTotals[card.name] += tx.amount; });
        const pieL = Object.keys(cardTotals).filter(k => cardTotals[k] > 0);
        const pieD = pieL.map(k => cardTotals[k]);

        const days = new Date(parseInt(m.slice(0,4)), parseInt(m.slice(5,7)), 0).getDate();
        const daily = new Array(days).fill(0);
        txs.forEach(tx => { daily[parseInt(tx.date.slice(8, 10)) - 1] += tx.amount; });
        const barL = Array.from({length: days}, (_, i) => (i + 1).toString());

        if(pieChart) pieChart.destroy(); if(barChart) barChart.destroy();
        pieChart = new Chart(document.getElementById('chart-cards').getContext('2d'), { type: 'doughnut', data: { labels: pieL, datasets: [{ data: pieD, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: textColor } } } } });
        barChart = new Chart(document.getElementById('chart-daily').getContext('2d'), { type: 'bar', data: { labels: barL, datasets: [{ label: 'æ”¯å‡º', data: daily, backgroundColor: '#ff4d4d', borderRadius: 3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid: { display: false } }, y: { ticks: { color: textColor }, grid: { color: '#333' } } }, plugins: { legend: { display: false } } } });
    }

    // Export/Import
    function exportData(type) {
        const str = type==='json' ? JSON.stringify(state) : 'Date,Desc,Amount\n'+state.transactions.map(t=>`${t.date},${t.desc},${t.amount}`).join('\n');
        const blob = new Blob([str], {type: type==='json'?'application/json':'text/csv'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.'+type; a.click();
    }
    function triggerImport() { document.getElementById('file-input').click(); }
    function importData(input) {
        const reader = new FileReader();
        reader.onload = e => { state = JSON.parse(e.target.result); saveData(); location.reload(); };
        reader.readAsText(input.files[0]);
    }
    function importPresetCards() {
        PRESET_CARDS.forEach(p=> { if(p.cap>0 && !state.cards.find(c=>c.name===p.name)) state.cards.push({...p, id: Date.now()+Math.random()}) });
        saveData(); render(); showToast('âœ… å·²åŒ¯å…¥ç¥å¡');
    }
    function toggleTheme() {
        const t = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
        document.documentElement.setAttribute('data-theme', t); localStorage.setItem(THEME_KEY, t);
        if (document.getElementById('tab-analysis').classList.contains('active')) renderCharts();
    }
    function applyTheme(t) { document.documentElement.setAttribute('data-theme', t); }
    function rescueData() { exportData('json'); }
    function resetData() { if(confirm('ç¢ºå®šæ¸…é™¤?')) { localStorage.removeItem(DB_KEY); location.reload(); } }

    init();
</script>
</body>
</html>
