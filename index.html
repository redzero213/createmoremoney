<!DOCTYPE html>
<html lang="zh-HK" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e1e">
    <title>å›è´ˆå“¥ - æ™ºèƒ½ç°½è³¬ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #00d26a; --primary-dark: #00a855; --bg: #121212; --surface: #1e1e1e; --surface-hover: #2d2d2d; --text: #e0e0e0; --text-muted: #a0a0a0; --danger: #ff4d4d; --income: #4facfe; --repay: #ff9f43; --miles: #a29bfe; --mission: #f39c12; --welcome: #e84393; --sub: #e17055; --trade: #00cec9; --info: #0984e3; --telegram: #229ED9; --border: #333; --card-gradient: linear-gradient(135deg, #2c3e50, #000000); --shadow: 0 4px 6px rgba(0,0,0,0.3); --chart-text: #e0e0e0; }
        [data-theme="light"] { --primary: #00b85c; --primary-dark: #008f45; --bg: #f4f6f8; --surface: #ffffff; --surface-hover: #eef2f5; --text: #1a1a1a; --text-muted: #666666; --danger: #d93025; --income: #1a73e8; --repay: #e37400; --miles: #6c5ce7; --mission: #d35400; --welcome: #d63031; --sub: #d63031; --trade: #00b894; --info: #0984e3; --telegram: #229ED9; --border: #e0e0e0; --card-gradient: linear-gradient(135deg, #2c3e50, #4ca1af); --shadow: 0 2px 8px rgba(0,0,0,0.08); --chart-text: #333333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        header { background: var(--surface); padding: 12px 20px; padding-top: max(12px, env(safe-area-inset-top)); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .app-logo { width: 28px; height: 28px; object-fit: contain; }
        .menu-btn { font-size: 0.9rem; background: var(--surface-hover); border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: max(80px, env(safe-area-inset-bottom)); }
        .panel { background: var(--surface); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: var(--surface-hover); padding: 15px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: var(--text); margin: 5px 0; word-break: break-word; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); }
        .profit-pos { color: var(--primary); } .profit-neg { color: var(--danger); }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .menu-item { background: var(--surface-hover); border: 1px solid var(--border); border-radius: 12px; padding: 20px 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .menu-item:hover { border-color: var(--primary); }
        .menu-icon { font-size: 2rem; } .menu-label { font-size: 0.9rem; font-weight: bold; } .menu-desc { font-size: 0.75rem; color: var(--text-muted); }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .item-main { flex: 1; }
        .item-title { font-weight: 500; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .item-sub { font-size: 0.8rem; color: var(--text-muted); }
        .item-amount { font-weight: bold; font-size: 1.1rem; text-align: right; margin-left: 10px; }
        .item-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .cat-tag, .shop-tag, .source-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--surface-hover); border: 1px solid var(--border); color: var(--text-muted); }
        .shop-tag { background: var(--trade); color: #000; font-weight: bold; }
        .source-tag { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--text-muted); margin-right: 4px;}
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .status-ordered { background: #f39c12; color: #000; } 
        .status-stock { background: #3498db; color: #fff; } 
        .status-sold { background: var(--primary); color: #fff; } 
        .status-cut { background: var(--danger); color: #fff; text-decoration: line-through; } 
        .cashback-tag { font-size: 0.75rem; color: var(--primary); background: rgba(0, 210, 106, 0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px;}
        .form-group { margin-bottom: 15px; } label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; outline: none; }
        .row-group { display: flex; gap: 10px; } .row-group > div { flex: 1; }
        .type-toggle { display: flex; background: var(--bg); border-radius: 8px; padding: 4px; border: 1px solid var(--border); margin-bottom: 15px; }
        .type-option { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        .type-option.active.expense { background: rgba(255, 77, 77, 0.15); color: var(--danger); }
        .type-option.active.income { background: rgba(79, 172, 254, 0.15); color: var(--income); }
        .type-option.active.repayment { background: rgba(255, 159, 67, 0.15); color: var(--repay); border: 1px solid var(--repay); }
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .grid-btn { padding: 5px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; cursor: pointer; font-size: 0.8rem; text-align: center; display:flex; align-items:center; justify-content:center; flex-direction:column; min-height:55px; line-height: 1.2; overflow-wrap: break-word; -webkit-tap-highlight-color: transparent;}
        .grid-btn:active { background: var(--surface); transform: scale(0.98); }
        .grid-btn.selected { background: var(--trade); color: #000; border-color: var(--trade); font-weight: bold; }
        .analysis-controls { display: flex; gap: 5px; background: var(--bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; overflow-x: auto; }
        .analysis-btn { flex: 1; padding: 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 6px; font-size: 0.85rem; white-space: nowrap; }
        .analysis-btn.active { background: var(--surface-hover); color: var(--text); font-weight: bold; }
        .btn { background: var(--primary); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; border-radius: 6px; background: var(--surface-hover); color: var(--text); border: 1px solid var(--border); cursor: pointer; }
        .btn-text { background: none; border: none; color: var(--text-muted); padding: 5px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.8rem; }
        .btn-repay { color: var(--repay); border-color: var(--repay); background: rgba(255, 159, 67, 0.1); }
        .btn-telegram { background: var(--telegram); border-color: var(--telegram); color: #fff; }
        .credit-card { background: var(--card-gradient); padding: 15px; border-radius: 10px; margin-bottom: 10px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); color: #fff; }
        .card-name { font-weight: bold; font-size: 1.1rem; color: #fff; }
        .card-info { font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .fab { position: fixed; bottom: max(20px, env(safe-area-inset-bottom) + 20px); right: 20px; background: var(--primary); color: #fff; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,210,106,0.4); cursor: pointer; border: none; z-index: 90; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--surface); width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; padding: 25px; border-radius: 16px; padding-bottom: 50px; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 10px; background: #cc4444; border: 2px solid #fff; color: #fff; width: 36px; height: 36px; border-radius: 50%; font-size: 1.4rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .close-modal:active { transform: scale(0.9); }
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; overflow-x: auto; white-space: nowrap; }
        .tab { flex: 1; padding: 10px; text-align: center; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; min-width: 80px; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 999; left: 50%; bottom: 80px; transform: translateX(-50%); border: 1px solid var(--primary); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 60px; opacity: 0;} }
        
        .checkbox-group { display: flex; flex-direction: column; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--surface); padding: 0; }
        .checkbox-item { display: flex; align-items: center; gap: 12px; font-size: 0.95rem; padding: 12px 15px; border-bottom: 1px solid var(--border); transition: background 0.2s; cursor: pointer; }
        .checkbox-item:last-child { border-bottom: none; }
        .checkbox-item:hover { background: var(--surface-hover); }
        .checkbox-item input { width: 22px; height: 22px; accent-color: var(--primary); cursor: pointer; margin: 0; }
        .checkbox-item span { flex: 1; color: var(--text); }
        
        .recur-item, .welcome-item { background: var(--surface-hover); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .recur-item.completed { border-color: var(--primary); background: rgba(0, 210, 106, 0.05); }
        .footer { text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 30px; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .toggle-switch { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; margin-bottom: 10px; }
        .toggle-switch input { width: auto; margin: 0; }
        .phone-icon { width: 22px; height: 40px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); position: relative; margin-bottom: 3px; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .phone-icon::before { content: ''; position: absolute; top: 5px; left: 4px; width: 10px; height: 10px; background: rgba(0,0,0,0.4); border-radius: 3px; }
        .phone-icon.silver { background: linear-gradient(135deg, #e3e4e5 0%, #999 100%); }
        .phone-icon.orange { background: linear-gradient(135deg, #C5B4A3 0%, #8C7C6D 100%); }
        .phone-icon.blue { background: linear-gradient(135deg, #3B4C58 0%, #202b36 100%); }
        .section-title { font-size: 0.85rem; color: var(--text-muted); margin: 15px 0 5px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 2px; }
        .log-list { max-height: 300px; overflow-y: auto; text-align: left; }
        .log-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .log-date { font-size: 0.75rem; color: var(--primary); font-weight: bold; }
        .log-content { font-size: 0.85rem; color: var(--text); line-height: 1.4; white-space: pre-line; }
        .search-bar { width: 100%; padding: 10px; margin-bottom: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); outline: none; }
        .cat-list-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); }
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 20px; }
        
        #error-console { display:none; background:#8b0000; color:#fff; padding:15px; font-size:0.85rem; position:fixed; bottom:0; left:0; right:0; z-index:1000; text-align:left; max-height:150px; overflow:auto; box-shadow: 0 -4px 10px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<header>
    <h1>
        <img src="https://cdn-icons-png.flaticon.com/512/6963/6963703.png" alt="Logo" class="app-logo"> 
        å›è´ˆå“¥
    </h1>
    <div class="header-actions">
        <button class="menu-btn" onclick="openMenuTarget('menu')">â˜° é¸å–®</button>
    </div>
</header>

<div class="container">
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-size:0.9rem; color:var(--text-muted);">æœ¬æœˆæ¦‚è¦½ <span id="billing-cycle-text" style="font-size:0.75rem;"></span></div>
            <button class="btn-text" onclick="openMenuTarget('subs')" style="font-size:0.8rem;">ğŸ”„ å›ºå®šé–‹æ”¯</button>
        </div>
        <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="stat-card"><div class="stat-label">æœ¬æœˆæ”¯å‡º</div><div class="stat-value" id="total-spent" style="color:var(--danger)">$0</div></div>
            <div class="stat-card"><div class="stat-label">æœ¬æœˆæ”¶å…¥</div><div class="stat-value" id="total-income" style="color:var(--income)">$0</div></div>
            <div class="stat-card"><div class="stat-label">å›è´ˆä¼°ç®—</div><div class="stat-value" id="total-cashback" style="color:var(--primary); font-size: 0.9rem;">$0</div></div>
        </div>
        <div id="missions-container"></div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('transactions')">è³¬ç›®ç´€éŒ„</div>
        <div class="tab" onclick="switchTab('cards')">å¡åŒ… / å¸³æˆ¶</div>
        <div class="tab" onclick="switchTab('trading')">ğŸ“± ç‚’è³£</div>
        <div class="tab" onclick="switchTab('analysis')">çµ±è¨ˆåˆ†æ</div>
    </div>

    <div id="tab-transactions" class="tab-content active">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">æœ€è¿‘è³¬ç›®</h2>
                <span class="stat-label" id="tx-count">0 ç­†</span>
            </div>
            <input type="text" id="search-tx" class="search-bar" placeholder="ğŸ” æœå°‹ç´€éŒ„ã€é¡åˆ¥æˆ–é‡‘é¡..." oninput="renderTransactions()">
            <div id="transaction-list"></div>
        </div>
    </div>

    <div id="tab-cards" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">æˆ‘çš„å¡åŒ…</h2>
                <div style="display:flex; gap:8px;">
                     <button class="btn-small" onclick="importPresetCards()" style="background:rgba(0,210,106,0.1); border-color:var(--primary); color:var(--primary);">ğŸ“¥ åŒ¯å…¥æ¨è–¦ç¥å¡</button>
                    <button class="btn-small" onclick="openModal('card')">+ æ–°å¢</button>
                </div>
            </div>
            <div id="card-list"></div>
        </div>
    </div>

    <div id="tab-trading" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0; font-size:1.1rem;">ğŸ“± iPhone 17 ç‚’è³£ç´€éŒ„</h2>
                <div style="display:flex; gap:8px;">
                    <button class="btn-small" onclick="sendTradeReport()" style="background:var(--telegram); color:white;">ğŸ“Š TGå ±æ•¸</button>
                    <button class="btn-small" onclick="openModal('trade')" style="background:var(--trade); border-color:var(--trade); color:#000;">+ æ–°å¢äº¤æ˜“</button>
                </div>
            </div>
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-bottom:15px;">
                <div class="stat-card"><div class="stat-label">ä»Šæ—¥åˆ©æ½¤</div><div class="stat-value" id="trade-today-profit" style="color:var(--primary)">$0</div></div>
                <div class="stat-card"><div class="stat-label">ä»Šæ—¥è²¨é‡</div><div class="stat-value" id="trade-today-vol" style="color:var(--text)">0 éƒ¨</div></div>
            </div>
            <input type="text" id="search-trade" class="search-bar" placeholder="ğŸ” æœå°‹åº—èˆ–ã€å‹è™Ÿæˆ–å–®è™Ÿ..." oninput="renderTrading()">
            <div id="trade-list"></div>
        </div>
    </div>

    <div id="tab-analysis" class="tab-content">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; font-size:1.1rem;">çµ±è¨ˆåˆ†æ</h2>
                 <button class="btn-small" onclick="sendTelegramReport()" style="background:var(--telegram); color:white;">âœˆï¸ æ¨é€</button>
            </div>
             
             <label class="toggle-switch">
                 <input type="checkbox" id="analysis-include-trade" onchange="renderCharts()">
                 <span>åŒ…å«ç‚’è³£æ•¸æ“š (Cost)</span>
             </label>

             <div class="analysis-controls">
                <button class="analysis-btn active" onclick="setAnalysisMode('month')" id="btn-mode-month">ğŸ“… å–®æœˆ</button>
                <button class="analysis-btn" onclick="setAnalysisMode('range')" id="btn-mode-range">ğŸ“† è‡ªè¨‚ç¯„åœ</button>
                <button class="analysis-btn" onclick="setAnalysisMode('compare')" id="btn-mode-compare">ğŸ†š æœˆåº¦æ¯”è¼ƒ</button>
            </div>
            <div id="analysis-inputs" style="margin-bottom:15px; display:flex; gap:10px; align-items:center;"></div>
            <div id="analysis-charts-container">
                <div style="margin-bottom:30px;"><div class="chart-container"><canvas id="chart-cards"></canvas></div></div>
                <div><div class="chart-container"><canvas id="chart-daily"></canvas></div></div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Copyright Â© Redezero | v1.82 çµ‚æ¥µä¿®å¾©ç‰ˆ <br>
        <button onclick="rescueData()" style="background:transparent; border:none; color:var(--text-muted); font-size:0.7rem; margin-top:10px;">â›‘ï¸ æ•¸æ“šæ€¥æ•‘ / ä¸‹è¼‰å‚™ä»½</button>
    </div>
</div>

<div id="main-fab"><button class="fab" onclick="openModal('transaction')">+</button></div>

<!-- Modals -->
<div id="modal-menu" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">Ã—</button>
        <h2>åŠŸèƒ½é¸å–®</h2>
        <div class="menu-grid">
            <div class="menu-item" onclick="openMenuTarget('mission')"><div class="menu-icon">â•</div><div class="menu-label">æ–°å¢é™æ™‚ä»»å‹™</div></div>
            <div class="menu-item" onclick="openMenuTarget('recur-mission')"><div class="menu-icon">ğŸ¯</div><div class="menu-label">æ¯æœˆä»»å‹™</div></div>
            <div class="menu-item" onclick="openMenuTarget('welcome')"><div class="menu-icon">ğŸ</div><div class="menu-label">è¿æ–°ç›£å¯Ÿ</div></div>
            <div class="menu-item" onclick="openMenuTarget('subs')"><div class="menu-icon">ğŸ”„</div><div class="menu-label">å›ºå®šé–‹æ”¯</div></div>
            <div class="menu-item" onclick="openMenuTarget('category')"><div class="menu-icon">ğŸ“‚</div><div class="menu-label">è‡ªè¨‚é¡åˆ¥</div></div>
            <div class="menu-item" onclick="openMenuTarget('bank-info')"><div class="menu-icon">â„¹ï¸</div><div class="menu-label">éŠ€è¡Œè³‡è¨Š</div></div>
            <div class="menu-item" onclick="openMenuTarget('data')"><div class="menu-icon">â˜ï¸</div><div class="menu-label">å‚™ä»½èˆ‡åŒæ­¥</div></div>
            <div class="menu-item" onclick="openMenuTarget('settings')"><div class="menu-icon">âš™ï¸</div><div class="menu-label">è¨­å®š</div></div>
            <div class="menu-item" onclick="toggleTheme(); closeModals();"><div class="menu-icon">ğŸŒ—</div><div class="menu-label">åˆ‡æ›æ¨¡å¼</div></div>
        </div>
        <div style="margin-top:15px; text-align:center;">
            <button class="btn-text" onclick="openMenuTarget('log')">ğŸ“‹ æŸ¥çœ‹æ›´æ–°æ—¥èªŒ</button>
        </div>
    </div>
</div>

<div id="modal-transaction" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">Ã—</button>
        <h2 id="tx-modal-title">æ–°å¢ç´€éŒ„</h2>
        <div class="type-toggle">
            <div class="type-option active expense" id="type-expense" onclick="setTxType('expense')">ğŸ’¸ æ”¯å‡º</div>
            <div class="type-option" id="type-income" onclick="setTxType('income')">ğŸ’° æ”¶å…¥</div>
            <div class="type-option" id="type-repayment" onclick="setTxType('repayment')">ğŸ’³ é‚„æ¬¾</div>
        </div>
        <form id="tx-form" onsubmit="addTransaction(event)">
            <input type="hidden" id="tx-type" value="expense">
            <input type="hidden" id="tx-id">
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;"><label>è²¨å¹£</label><select id="tx-currency" onchange="handleCurrencyChange()"></select></div>
                <div style="flex:1; display:none;" id="fx-rate-container"><label>åŒ¯ç‡</label><input type="number" id="tx-fx-rate" step="0.0001" oninput="calcHkdAmount()"></div>
            </div>
            <input type="checkbox" id="tx-is-foreign" style="display:none;">
            <div class="form-group" id="fx-amount-container" style="display:none;"><label>å¤–å¹£é‡‘é¡</label><input type="number" id="tx-fx-amount" step="0.01" oninput="calcHkdAmount()"></div>
            <div class="form-group"><label id="lbl-amount">é‡‘é¡ (HKD)</label><div style="display:flex; gap:10px;"><input type="number" id="tx-amount" step="0.1" required style="flex:1;"><button type="button" class="btn-small" onclick="openModal('split')">âœ‚ï¸</button></div></div>
            <div class="form-group" id="group-category"><label>é¡åˆ¥</label><select id="tx-category" required></select></div>
            <div class="form-group" id="group-card">
                <label>é¸æ“‡ä¿¡ç”¨å¡</label><select id="tx-card" onchange="updateCardHint()"></select>
                <div id="card-hint" style="font-size:0.8rem; color:var(--primary); margin-top:5px; display:none;"></div>
            </div>
            <div class="form-group"><label>æè¿°</label><input type="text" id="tx-desc" required></div>
            <div class="form-group"><label>æ—¥æœŸæ™‚é–“</label><input type="datetime-local" id="tx-date" required></div>
            <div style="display:flex; gap:10px;"><button type="submit" class="btn" id="btn-submit" style="flex:2;">è¨˜è³¬</button></div>
        </form>
    </div>
</div>

<div id="modal-trade" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">Ã—</button>
        <h2>ğŸ“± æ–°å¢ iPhone 17 äº¤æ˜“</h2>
        <form id="trade-form" onsubmit="addTrade(event)">
            <input type="hidden" id="trade-id">
            
            <div class="section-title">1. è¨‚å–®è³‡æ–™</div>
            <div class="row-group">
                <div class="form-group">
                    <label>è³¼å…¥ä¾†æº</label>
                    <select id="trade-source" onchange="toggleCustomInput('source')" required></select>
                    <input type="text" id="trade-source-custom" placeholder="è«‹è¼¸å…¥ä¾†æº" style="display:none; margin-top:5px;">
                </div>
                <div class="form-group"><label>å–®è™Ÿ (é¸å¡«)</label><input type="text" id="trade-oid" placeholder="W123..."></div>
            </div>
            
            <div class="section-title">2. äº¤æ˜“ç‹€æ…‹</div>
            <div class="form-group">
                <div class="btn-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="grid-btn selected" onclick="selectTradeOption('status', 'pending', this)">ğŸ›’ å·²è¨‚<br>(æœªå–)</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'stock', this)">ğŸ“¦ ç¾è²¨<br>(åœ¨æ‰‹)</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'sold', this)">ğŸ’° å·²è³£<br>(å®Œæˆ)</div>
                    <div class="grid-btn" onclick="selectTradeOption('status', 'cut', this)">âŒ Cutå–®<br>(ä½”é¡)</div>
                </div>
                <input type="hidden" id="trade-status" value="pending" required>
            </div>

            <div class="section-title">3. å›æ”¶åº—èˆ– (å¦‚å·²è³£å‡º)</div>
            <div class="form-group">
                <select id="trade-shop" onchange="toggleCustomInput('shop')"></select>
                <input type="text" id="trade-shop-custom" placeholder="è«‹è¼¸å…¥åº—èˆ–åç¨±" style="display:none; margin-top:5px;">
            </div>

            <div class="section-title">4. è¦æ ¼ & è²¡å‹™</div>
            <div class="form-group"><label>å‹è™Ÿ</label>
                <div class="btn-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="grid-btn" onclick="selectTradeOption('model', 'Pro', this)">Pro</div>
                    <div class="grid-btn" onclick="selectTradeOption('model', 'Pro Max', this)">Pro Max</div>
                </div><input type="hidden" id="trade-model" required>
            </div>
            <div class="form-group"><label>å®¹é‡</label>
                <div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="grid-btn" onclick="selectTradeOption('cap', '256GB', this)">256GB</div>
                    <div class="grid-btn" onclick="selectTradeOption('cap', '512GB', this)">512GB</div>
                    <div class="grid-btn" onclick="selectTradeOption('cap', '1TB', this)">1TB</div>
                </div><input type="hidden" id="trade-cap" required>
            </div>
            <div class="form-group"><label>é¡è‰²</label>
                <div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="grid-btn" onclick="selectTradeOption('color', 'éŠ€', this)"><div class="phone-icon silver"></div>éŠ€</div>
                    <div class="grid-btn" onclick="selectTradeOption('color', 'æ©™', this)"><div class="phone-icon orange"></div>æ©™</div>
                    <div class="grid-btn" onclick="selectTradeOption('color', 'è—', this)"><div class="phone-icon blue"></div>è—</div>
                </div><input type="hidden" id="trade-color" required>
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                <label>ç‹€æ…‹:</label>
                <div class="btn-grid" style="grid-template-columns: 1fr 1fr; width:100%; margin:0;">
                    <div class="grid-btn selected" onclick="selectTradeOption('condition', 'sealed', this)">ğŸ”’ åŸå°</div>
                    <div class="grid-btn" onclick="selectTradeOption('condition', 'opened', this)">ğŸ”ª é–‹å°</div>
                </div>
                <input type="hidden" id="trade-condition" value="sealed">
            </div>

            <div class="row-group">
                <div class="form-group"><label>åŸåƒ¹/æˆæœ¬</label><input type="number" id="trade-cost" required></div>
                <div class="form-group"><label>æ”¾å”®åƒ¹</label><input type="number" id="trade-price" value="0" required></div>
            </div>
            <div class="row-group">
                <div class="form-group"><label>æ•¸é‡</label><div style="display:flex;gap:10px;"><button type="button" class="btn-small" onclick="adjustTradeQty(-1)">-</button><input type="number" id="trade-qty" value="1" style="text-align:center;"><button type="button" class="btn-small" onclick="adjustTradeQty(1)">+</button></div></div>
                <div class="form-group">
                    <label>ä»˜æ¬¾ä¿¡ç”¨å¡</label>
                    <select id="trade-card"><option value="">ç„¡ä½¿ç”¨ä¿¡ç”¨å¡</option></select>
                </div>
            </div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="datetime-local" id="trade-date" required></div>
            <button type="submit" class="btn" style="background:var(--trade); color:#000;">å„²å­˜äº¤æ˜“</button>
        </form>
    </div>
</div>

<div id="modal-category" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModals()">Ã—</button>
        <h2 style="margin-top:0;">ğŸ“‚ è‡ªè¨‚æ”¶æ”¯é¡åˆ¥</h2>
        <div class="type-toggle">
            <div class="type-option active expense" id="cat-type-expense" onclick="switchCatType('expense')">æ”¯å‡ºé¡åˆ¥</div>
            <div class="type-option" id="cat-type-income" onclick="switchCatType('income')">æ”¶å…¥é¡åˆ¥</div>
        </div>
        <div id="category-list" style="margin-bottom:15px; max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px;"></div>
        <form onsubmit="addCategory(event)">
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-category-name" placeholder="è¼¸å…¥æ–°é¡åˆ¥åç¨±" required style="flex:1;">
                <button type="submit" class="btn-small" style="background:var(--primary); color:#fff;">æ–°å¢</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-split" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>âœ‚ï¸ åˆ†å–®</h2><div class="form-group"><input type="number" id="split-total" placeholder="ç¸½é¡" oninput="calcSplit()"></div><div class="row-group"><label><input type="checkbox" id="split-service" onchange="calcSplit()" style="width:auto;"> +10%</label><input type="number" id="split-discount" placeholder="æŠ˜æ‰£%" oninput="calcSplit()"></div><div class="form-group"><div style="display:flex;gap:10px;"><button type="button" class="btn-small" onclick="adjustPeople(-1)">-</button><input type="number" id="split-people" value="2" style="text-align:center;" oninput="calcSplit()"><button type="button" class="btn-small" onclick="adjustPeople(1)">+</button></div></div><div style="text-align:center; margin:15px;"><div id="split-result" style="font-size:2rem; font-weight:bold;">$0.00</div></div><button type="button" class="btn" onclick="applySplit()">å¡«å…¥</button></div></div>
<div id="modal-card" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>æ–°å¢å¡ç‰‡</h2><form id="card-form" onsubmit="addCard(event)"><div class="form-group"><label>å¡ç‰‡åç¨±</label><input type="text" id="card-name" required></div><div class="form-group"><label>å›è´ˆæ¯”ç‡ (%)</label><input type="number" id="card-percent" step="0.1" required></div><div class="form-group"><label>ç°½è³¬ä¸Šé™ (ç•™ç©ºç‚ºç„¡é™)</label><input type="number" id="card-cap"></div><div class="form-group"><label>å‚™è¨»</label><input type="text" id="card-note"></div><button type="submit" class="btn">æ–°å¢å¡ç‰‡</button></form></div></div>
<div id="modal-recur-mission" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>æ¯æœˆä»»å‹™</h2><div id="recur-list" style="margin-bottom:15px;"></div><form onsubmit="addRecurMission(event)"><input type="text" id="recur-name" required placeholder="ä»»å‹™å"><div class="row-group"><input type="number" id="recur-target" required placeholder="ç›®æ¨™"><select id="recur-card" required></select></div><select id="recur-reset-day"><option value="1">1è™Ÿé‡ç½®</option><option value="12">12è™Ÿé‡ç½®</option></select><button type="submit" class="btn-small" style="width:100%; margin-top:10px;">+ åŠ å…¥</button></form></div></div>
<div id="modal-welcome" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>è¿æ–°ç›£å¯Ÿ</h2><div id="welcome-list" style="margin-bottom:15px;"></div><form onsubmit="addWelcome(event)"><input type="text" id="welcome-name" required placeholder="è¿æ–°å"><div class="row-group"><select id="welcome-card" required></select><input type="number" id="welcome-target" required placeholder="ç›®æ¨™"></div><input type="date" id="welcome-deadline" required><input type="date" id="welcome-start" required><button type="submit" class="btn-small" style="width:100%; margin-top:10px;">+ åŠ å…¥</button></form></div></div>
<div id="modal-subs" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>å›ºå®šé–‹æ”¯</h2><div id="subs-list" style="margin-bottom:15px;"></div><form onsubmit="addSubscription(event)"><input type="text" id="sub-name" required placeholder="é …ç›®"><div class="row-group"><input type="number" id="sub-amount" required placeholder="é‡‘é¡"><select id="sub-card" required></select></div><button type="submit" class="btn-small" style="width:100%; margin-top:10px;">+ åŠ å…¥</button></form></div></div>
<div id="modal-bank-info" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>éŠ€è¡Œè³‡è¨Š</h2><div id="bank-list"></div></div></div>
<div id="modal-data" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>å‚™ä»½èˆ‡åŒæ­¥</h2><button class="btn" onclick="exportData('json')" style="background:#ff9f43; margin-bottom:10px;">ğŸ’¾ ä¸‹è¼‰å‚™ä»½ (JSON)</button><button class="btn" onclick="exportData('csv')" style="background:#4facfe; margin-bottom:10px;">ğŸ“Š åŒ¯å‡º Excel (CSV)</button><button class="btn" style="background:#333; border:1px solid #666; margin-bottom:20px;" onclick="triggerImport()">ğŸ“‚ é‚„åŸå‚™ä»½</button><input type="file" id="file-input" accept=".json" onchange="importData(this)" style="display:none;"><button class="btn-small" onclick="resetData()" style="color:var(--danger); border-color:var(--danger); width:100%;">ğŸ”¥ é‡ç½®è³‡æ–™ (æ¸…ç©º)</button></div></div>
<div id="modal-settings" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>âš™ï¸ è¨­å®š</h2><select id="setting-start-day" onchange="saveSettings()"></select><hr><div class="form-group"><label>Telegram Bot Token</label><input type="password" id="tg-token" placeholder="Bot Token" onchange="saveTGSettings()"></div><div class="form-group"><label>Telegram Chat ID</label><input type="text" id="tg-chatid" placeholder="Chat ID" onchange="saveTGSettings()"></div><div class="form-group"><label><input type="checkbox" id="setting-tg-auto" onchange="saveTGSettings()" style="width:auto; margin-right:8px;"> é–‹å•Ÿ TG è‡ªå‹•é€šçŸ¥ (å«çˆ†é¡é è­¦)</label></div><button class="btn-small" onclick="testTG()" style="width:100%;">æ¸¬è©¦ç™¼é€</button></div></div>
<div id="modal-mission" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>é™æ™‚ä»»å‹™</h2><form onsubmit="addMission(event)"><input type="text" id="mission-name" required placeholder="ä»»å‹™å"><input type="number" id="mission-target" required placeholder="ç›®æ¨™"><div class="row-group"><input type="date" id="mission-start"><input type="date" id="mission-end"></div><div id="mission-cards" class="checkbox-group" style="margin-top:10px; margin-bottom:15px;"></div><button type="submit" class="btn">å»ºç«‹</button></form></div></div>
<div id="modal-log" class="modal-overlay"><div class="modal-content"><button class="close-modal" onclick="closeModals()">Ã—</button><h2>æ›´æ–°æ—¥èªŒ</h2><div class="log-list"><div class="log-item"><div class="log-date">v1.82 (çµ‚æ¥µå®‰å…¨ç‰ˆ)</div><div class="log-content">- ä¿®å¾©ï¼šå°‹å›æ‰€æœ‰èˆŠæœ‰åŠŸèƒ½åŠéš±è—é¸å–® (å›ºå®šé–‹æ”¯/ä»»å‹™ç­‰)ã€‚<br>- å„ªåŒ–ï¼šåŠ å…¥é ‚ç´šé˜²å´©æ½°æ©Ÿåˆ¶ã€‚<br>- é½Šå…¨ï¼šç‚’è³£è¤‡è£½ã€æœå°‹éæ¿¾ã€TGè‡ªå‹•å ±æ•¸å®Œå…¨ç”Ÿæ•ˆã€‚</div></div></div></div></div>

<div id="error-console"></div>
<div id="toast"></div>

<script>
    // --- çµ‚æ¥µé˜²å´©æ½°ç³»çµ± ---
    window.onerror = function(msg, url, line) {
        const div = document.getElementById('error-console');
        if(div) { div.style.display = 'block'; div.innerHTML += `ğŸ”´ Error: ${msg} <br>Line: ${line}<br>è«‹æˆªåœ–ä¸¦é€šçŸ¥é–‹ç™¼è€…ã€‚`; }
        return false;
    };

    // --- è¨­å®šåŠè³‡æ–™åº« ---
    const DB_KEY = 'rebate_bro_data_v2';
    const THEME_KEY = 'rebate_bro_theme';
    
    const TRADE_SOURCES = ['AOS (å®˜ç¶²)', 'APU (åº—å–)', 'ç™¾è€åŒ¯', 'è±æ¾¤', 'å‹å’Œ', 'è˜‡å¯§', 'é›»å™¨å¹«', 'CMHK', 'CSL', 'Smartone', '3HK', 'ä¸­åŸ', '1010'];
    const TRADE_SHOPS = ['é›ªçƒ', 'è¬é€š', 'æ—¥éŸ“', 'èª ä¿¡', 'bobo', 'YY', 'G79', 'F9', 'DIY', 'æ–°å®‡å®™', 'æº«è¨˜', 'éµ¬ç¨‹', 'iTrade', 'æ˜Ÿè€€', 'Carousell'];
    const IPHONE_PRICES = { 'Pro': { '256GB': 9399, '512GB': 11099, '1TB': 12799 }, 'Pro Max': { '256GB': 10199, '512GB': 11899, '1TB': 13599, '2TB': 16999 } };
    const CURRENCIES = ['HKD', 'CNY', 'USD', 'JPY', 'TWD', 'GBP', 'EUR', 'KRW', 'AUD', 'SGD'];
    
    const DEFAULT_CATEGORIES = { expense: ['é£Ÿé£¯', 'å…«é”é€šå¢å€¼', 'è³¼ç‰©', 'å¨›æ¨‚', 'é›œè²»', 'å…¶ä»–', 'å›ºå®šé–‹æ”¯'], income: ['è–ªé‡‘', 'è³£é‡', 'æŠ•è³‡', 'å…¶ä»–'], repayment: ['ä¿¡ç”¨å¡é‚„æ¬¾'] };
    
    const PRESET_CARDS = [ 
        { name: 'ç¾é‡‘', percent: 0, cap: 0, note: '' }, 
        { name: 'ä¿¡éŠ€ Motion', percent: 6, cap: 3600, note: 'é¤é£²/ç¶²è³¼6%' },
        { name: 'AEON WAKUWAKU', percent: 6, cap: 5000, note: 'ç¶²è³¼6%' },
        { name: 'æ’ç”Ÿ MMPOWER', percent: 5, cap: 10000, note: 'è‡ªé¸é¡åˆ¥5%' },
        { name: 'ä¸­éŠ€ Chill', percent: 5, cap: 3260, note: 'å½±è¦–/å¿«é¤5%' },
        { name: 'æ»™è± Red å¡', percent: 4, cap: 12500, note: 'ç¶²è³¼4%' },
        { name: 'å¯Œé‚¦ iN Visa', percent: 8, cap: 3750, note: 'æŒ‡å®šé¡åˆ¥8%' },
        { name: 'å®‰ä¿¡ EarnMORE', percent: 2, cap: 150000, note: 'å…¨åŸ2%' }
    ];

    const BANK_INFO = [
        { name: 'HSBC åŒ¯è±', promoUrl: 'https://www.redhotoffers.hsbc.com.hk/', rewardUrl: 'https://www.hsbc.com.hk/zh-hk/credit-cards/rewards/reward-cash/', csPhone: '2233 3000', csTrick: 'é¸èªè¨€ > 1 > 0' },
        { name: 'Standard Chartered æ¸£æ‰“', promoUrl: 'https://www.sc.com/hk/zh/credit-cards/promotion/', rewardUrl: 'https://www.sc.com/hk/zh/credit-cards/360-rewards/', csPhone: '2886 4111', csTrick: 'é¸èªè¨€ > 2 > 0' },
        { name: 'Hang Seng æ’ç”Ÿ', promoUrl: 'https://www.hangseng.com/zh-hk/personal/cards/', rewardUrl: 'https://www.hangseng.com/zh-hk/personal/cards/cash-dollars/', csPhone: '2998 9188', csTrick: 'é¸èªè¨€ > 1 > 0' },
        { name: 'BOC ä¸­éŠ€é¦™æ¸¯', promoUrl: 'https://www.bochk.com/tc/creditcard/promotions.html', rewardUrl: 'https://www.bochk.com/tc/creditcard/reward.html', csPhone: '2853 8828', csTrick: 'é¸èªè¨€ > 1 > 0' },
        { name: 'DBS æ˜Ÿå±•', promoUrl: 'https://www.dbs.com.hk/personal-zh/credit-cards/promotions/default.page', rewardUrl: 'https://www.dbs.com.hk/personal-zh/credit-cards/rewards.page', csPhone: '2290 8888', csTrick: 'é¸èªè¨€ > 1 > 0' },
        { name: 'Citi èŠ±æ——', promoUrl: 'https://www1.citibank.com.hk/chinese/credit-cards/promotions', rewardUrl: 'https://www1.citibank.com.hk/chinese/credit-cards/rewards', csPhone: '2860 0333', csTrick: 'é¸èªè¨€ > *0' },
        { name: 'BEA æ±äº', promoUrl: 'https://www.hkbea.com/html/tc/bea-credit-card-spending-offer.html', rewardUrl: '', csPhone: '3608 6628', csTrick: 'é¸èªè¨€ > 1 > 9' },
        { name: 'EarnMORE / WeWa', promoUrl: 'https://www.primecredit.com/credit-card/latest-offer/', rewardUrl: 'https://www.primecredit.com/credit-card/wewa-club/', csPhone: '2269 8888', csTrick: 'é¸èªè¨€ > 0' }
    ];

    let state = { transactions: [], cards: [], trades: [], missions: [], recurringMissions: [], welcomeOffers: [], subscriptions: [], categories: null, settings: {} };
    let pieChart = null, barChart = null, currentCatEditType = 'expense';

    // --- å•Ÿå‹•èˆ‡å®‰å…¨æª¢æŸ¥ ---
    function init() {
        try {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) state = JSON.parse(stored);
            
            // å®‰å…¨é˜²ç¦¦ (è£œå›æ‰€æœ‰éºå¤±çš„å±¬æ€§)
            if(!state.transactions) state.transactions = [];
            if(!state.cards) state.cards = [];
            if(!state.trades) state.trades = [];
            if(!state.missions) state.missions = [];
            if(!state.recurringMissions) state.recurringMissions = [];
            if(!state.welcomeOffers) state.welcomeOffers = [];
            if(!state.subscriptions) state.subscriptions = [];
            if(!state.settings) state.settings = { tgAutoSend: false, startDay: 1 };
            if(!state.categories) state.categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));

            // åˆå§‹åŒ–é¸é …
            const dS = document.getElementById('setting-start-day');
            if(dS) { dS.innerHTML=''; for(let i=1;i<=31;i++) { dS.add(new Option(i+'è™Ÿ', i)); } dS.value=state.settings.startDay || 1; }
            
            const cS = document.getElementById('tx-currency');
            if(cS) { cS.innerHTML=''; CURRENCIES.forEach(c=>cS.add(new Option(c, c))); }
            
            const sourceS = document.getElementById('trade-source');
            if(sourceS) { 
                sourceS.innerHTML = '<option value="">-- é¸æ“‡ä¾†æº --</option>';
                TRADE_SOURCES.forEach(src => sourceS.add(new Option(src, src)));
                sourceS.add(new Option('å…¶ä»– (æ‰‹å‹•è¼¸å…¥)', 'other'));
            }
            const shopS = document.getElementById('trade-shop');
            if(shopS) { 
                shopS.innerHTML = '<option value="">-- è«‹é¸æ“‡ (æœªè³£å‡ºå¯ä¸å¡«) --</option>';
                TRADE_SHOPS.forEach(sh => shopS.add(new Option(sh, sh)));
                shopS.add(new Option('å…¶ä»– (æ‰‹å‹•è¼¸å…¥)', 'other'));
            }

            if(document.getElementById('tg-token')) document.getElementById('tg-token').value = state.settings.tgToken || '';
            if(document.getElementById('tg-chatid')) document.getElementById('tg-chatid').value = state.settings.tgChatId || '';
            if(document.getElementById('setting-tg-auto')) document.getElementById('setting-tg-auto').checked = state.settings.tgAutoSend || false;

            applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
            setDefaultTime();
            if(document.getElementById('analysis-month')) document.getElementById('analysis-month').value = new Date().toISOString().slice(0, 7);
            
            setTxType('expense');
            render();
        } catch (err) { 
            console.error(err);
            const errDiv = document.getElementById('error-console');
            if(errDiv) { errDiv.style.display='block'; errDiv.innerHTML = `âš ï¸ ç³»çµ±å•Ÿå‹•æ””æˆªå´©æ½°ã€‚<br>è«‹é‡æ–°æ•´ç†æˆ–æŒ‰æ€¥æ•‘å‚™ä»½ã€‚<br>éŒ¯èª¤: ${err.message}`; }
        }
    }

    function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = 'show'; setTimeout(()=>t.className='', 2500); }

    // --- ä»‹é¢æ¸²æŸ“ ---
    function render() {
        try { renderCards(); } catch(e){ console.error(e); }
        try { renderTransactions(); } catch(e){ console.error(e); }
        try { renderTrading(); } catch(e){ console.error(e); }
        try { updateFormOptions(); } catch(e){ console.error(e); }
        try { calculateStats(); } catch(e){ console.error(e); }
        try { renderMissions(); } catch(e){ console.error(e); }
        try { if (document.getElementById('tab-analysis').classList.contains('active')) renderCharts(); } catch(e){ console.error(e); }
    }

    function renderCards() {
        const l = document.getElementById('card-list'); if(!l) return;
        l.innerHTML = '';
        state.cards.forEach(card => {
            const capText = card.cap > 0 ? ` / $${card.cap.toLocaleString()}` : '';
            const rateVal = card.percent !== undefined ? card.percent : (card.rate || 0);
            l.innerHTML += `<div class="credit-card"><div style="display:flex; justify-content:space-between; align-items:start;"><div><div class="card-name">${card.name}</div><div class="card-info" style="color:var(--primary);">${rateVal}% å›è´ˆ</div></div><button class="btn-text" onclick="deleteCard(${card.id})" style="color:#fff; font-size:1.2rem;">&times;</button></div><div class="progress-bar"><div id="prog-${card.id}" class="progress-fill"></div></div><div class="card-info"><span>æœ¬æœˆå·²ç°½: <span id="spent-${card.id}">$0</span>${capText}</span></div></div>`;
        });
        if(state.cards.length === 0) l.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">æœªæœ‰ä¿¡ç”¨å¡</div>';
    }

    function renderTransactions() {
        const l = document.getElementById('transaction-list'); if(!l) return;
        l.innerHTML = '';
        let sorted = [...(state.transactions || [])].sort((a,b) => { const dA = a.date?new Date(a.date):new Date(0); const dB = b.date?new Date(b.date):new Date(0); return dB - dA; });
        const q = document.getElementById('search-tx') ? document.getElementById('search-tx').value.toLowerCase() : '';
        if(q) sorted = sorted.filter(tx => (tx.desc||'').toLowerCase().includes(q) || (tx.category||'').toLowerCase().includes(q));
        if(sorted.length === 0) l.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">ç„¡ç´€éŒ„</div>';
        
        sorted.forEach(tx => {
            const card = state.cards.find(c => c.id == tx.cardId);
            const cName = card ? card.name : 'æœªçŸ¥å¡ç‰‡';
            const color = tx.type === 'income' ? 'var(--income)' : (tx.type === 'repayment' ? 'var(--repay)' : 'var(--text)');
            const sign = tx.type === 'income' ? '+' : (tx.type === 'repayment' ? '-' : '');
            const dStr = tx.date ? tx.date.replace('T', ' ') : '';
            l.innerHTML += `<div class="list-item"><div class="item-main"><div class="item-title"><span class="cat-tag">${tx.category||'å…¶ä»–'}</span> ${tx.desc||''}</div><div class="item-sub">${dStr} â€¢ ${cName}</div></div><div style="text-align:right"><div class="item-amount" style="color:${color}">${sign}$${Number(tx.amount).toLocaleString()}</div><button class="btn-text" style="font-size:0.75rem;" onclick="deleteTransaction(${tx.id})">åˆªé™¤</button></div></div>`;
        });
    }

    function renderTrading() {
        const l = document.getElementById('trade-list'); if(!l) return;
        l.innerHTML = '';
        let sortedTrades = [...(state.trades || [])].sort((a,b) => { const dA = a.date?new Date(a.date):new Date(0); const dB = b.date?new Date(b.date):new Date(0); return dB - dA; });
        const q = document.getElementById('search-trade') ? document.getElementById('search-trade').value.toLowerCase() : '';
        if(q) sortedTrades = sortedTrades.filter(t => (t.model||'').toLowerCase().includes(q) || (t.shop||'').toLowerCase().includes(q) || (t.oid||'').toLowerCase().includes(q));

        let todayProfit = 0, todayVol = 0;
        const nowMonth = new Date().toISOString().slice(0, 10);

        sortedTrades.forEach(t => {
            if (t.date && t.date.slice(0, 10) === nowMonth) {
                if (t.status !== 'cut') todayVol += (Number(t.qty) || 1);
                if (t.status === 'sold') todayProfit += (Number(t.profit) || 0);
            }
            let sBadge = '', pDisp = '';
            if (t.status === 'pending') sBadge = '<span class="status-badge status-ordered">ğŸ›’ å·²è¨‚</span>';
            else if (t.status === 'stock') sBadge = '<span class="status-badge status-stock">ğŸ“¦ ç¾è²¨</span>';
            else if (t.status === 'cut') sBadge = '<span class="status-badge status-cut">âŒ Cutå–®</span>';
            else { sBadge = '<span class="status-badge status-sold">ğŸ’° å·²è³£</span>' + (t.condition==='opened'?'ğŸ”ª':''); const pC = t.profit>=0?'profit-pos':'profit-neg'; pDisp = `<span class="${pC}">$${(Number(t.profit)||0).toLocaleString()}</span>`; }
            
            const oid = t.oid ? `(${t.oid})` : '';
            const loc = (t.status === 'sold' && t.shop) ? `${t.source||''} ${oid} â” ${t.shop}` : `${t.source||''} ${oid}`;
            const cName = state.cards.find(c => c.id == t.cardId) ? `<span class="cat-tag">ğŸ’³ ${state.cards.find(c=>c.id==t.cardId).name}</span>` : '';
            l.innerHTML += `<div class="list-item"><div class="item-main"><div class="item-title">${sBadge} ${t.model||''} ${t.cap||''}</div><div class="item-sub">${loc} â€¢ ${t.date?t.date.slice(0,10):''} ${cName}</div></div><div style="text-align:right"><div class="item-amount" style="font-size:0.9rem;">x${t.qty||1} ${pDisp}</div><div style="display:flex; justify-content:flex-end;"><button class="btn-text" onclick="cloneTrade(${t.id})" title="è¤‡è£½æ­¤å–®">ğŸ“‹</button><button class="btn-text" onclick="editTrade(${t.id})">âœ</button><button class="btn-text" onclick="deleteTrade(${t.id})">X</button></div></div></div>`;
        });
        
        if(document.getElementById('trade-today-profit')) document.getElementById('trade-today-profit').innerText = '$' + todayProfit.toLocaleString();
        if(document.getElementById('trade-today-vol')) document.getElementById('trade-today-vol').innerText = todayVol + ' éƒ¨';
        if(sortedTrades.length === 0) l.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">ç„¡äº¤æ˜“</div>';
    }

    function calculateStats() {
        let spent=0, inc=0, repay=0, cash=0;
        const cardSpent = {}; state.cards.forEach(c => cardSpent[c.id]=0);
        const nowMonth = new Date().toISOString().slice(0, 7);

        (state.transactions || []).forEach(tx => {
            if(tx.date && tx.date.startsWith(nowMonth)) {
                const amt = Number(tx.amount) || 0;
                if(tx.type==='expense') {
                    spent += amt;
                    if(tx.cardId && cardSpent[tx.cardId] !== undefined) { cardSpent[tx.cardId] += amt; const c = state.cards.find(x=>x.id==tx.cardId); if(c) cash += (amt * (c.percent||c.rate||0) / 100); }
                } else if(tx.type==='income') inc += amt;
                else if(tx.type==='repayment') repay += amt;
            }
        });
        (state.trades || []).forEach(t => {
            if(t.date && t.date.startsWith(nowMonth) && t.cardId && t.status !== 'cut') {
                const cst = (Number(t.cost)||0) * (Number(t.qty)||1);
                if(cardSpent[t.cardId] !== undefined) { cardSpent[t.cardId] += cst; const c = state.cards.find(x=>x.id==t.cardId); if(c) cash += (cst * (c.percent||c.rate||0) / 100); }
            }
        });

        if(document.getElementById('total-spent')) document.getElementById('total-spent').innerText = '$'+spent.toLocaleString();
        if(document.getElementById('total-income')) document.getElementById('total-income').innerText = '$'+inc.toLocaleString();
        if(document.getElementById('total-cashback')) document.getElementById('total-cashback').innerText = '$'+cash.toFixed(1);
        if(document.getElementById('tx-count')) document.getElementById('tx-count').innerText = (state.transactions || []).length + ' ç­†';

        state.cards.forEach(c => {
             const s = cardSpent[c.id] || 0;
             if(document.getElementById('spent-'+c.id)) document.getElementById('spent-'+c.id).innerText = '$'+s.toLocaleString();
             const elBar = document.getElementById('prog-'+c.id); 
             if(elBar && c.cap > 0) {
                 const pct = Math.min((s/c.cap)*100, 100);
                 elBar.style.width = pct+'%';
                 elBar.style.backgroundColor = pct>=100 ? 'var(--danger)' : 'var(--primary)';
             }
        });
    }

    // --- å„é¡æ¸²æŸ“ (ä»»å‹™ã€éŠ€è¡Œç­‰) ---
    function renderRecurList() {
        const l = document.getElementById('recur-list'); if(!l) return; l.innerHTML = '';
        (state.recurringMissions || []).forEach(m => {
            const c = state.cards.find(x=>x.id==m.cardId);
            l.innerHTML += `<div class="list-item"><div class="item-main"><div class="item-title">${m.name}</div><div class="item-sub">$${m.target} | æ¯æœˆ${m.resetDay}è™Ÿ | ${c?c.name:''}</div></div><button class="btn-text" onclick="deleteRecurMission(${m.id})">åˆªé™¤</button></div>`;
        });
    }
    function renderWelcomeList() {
        const l = document.getElementById('welcome-list'); if(!l) return; l.innerHTML = '';
        (state.welcomeOffers || []).forEach(w => {
            const c = state.cards.find(x=>x.id==w.cardId);
            l.innerHTML += `<div class="list-item"><div class="item-main"><div class="item-title">${w.name}</div><div class="item-sub">ç›®æ¨™: $${w.target} | ${c?c.name:''} | æˆªæ­¢: ${w.deadline}</div></div><button class="btn-text" onclick="deleteWelcome(${w.id})">åˆªé™¤</button></div>`;
        });
    }
    function renderSubsList() {
        const l = document.getElementById('subs-list'); if(!l) return; l.innerHTML = '';
        (state.subscriptions || []).forEach(s => {
            const c = state.cards.find(x=>x.id==s.cardId);
            l.innerHTML += `<div class="list-item"><div class="item-main"><div class="item-title">${s.name}</div><div class="item-sub">${c?c.name:''}</div></div><div style="display:flex;align-items:center;gap:10px;"><div class="item-amount">$${s.amount}</div><button class="btn-text" onclick="deleteSub(${s.id})">åˆªé™¤</button></div></div>`;
        });
    }
    function renderBankList() {
        const l = document.getElementById('bank-list'); if(!l) return; l.innerHTML = '';
        BANK_INFO.forEach(b => { l.innerHTML += `<div class="list-item" style="flex-direction:column; align-items:flex-start; gap:5px;"><div style="font-weight:bold; color:var(--primary);">${b.name}</div><div style="font-size:0.85rem; color:var(--text);">ğŸ“ CS: <a href="tel:${b.csPhone.replace(/ /g,'')}" style="color:var(--info); text-decoration:none;">${b.csPhone}</a> (æŒ‰æ³•: ${b.csTrick})</div><div style="font-size:0.8rem; display:flex; gap:10px;"><a href="${b.promoUrl}" target="_blank" style="color:var(--text-muted);">æ¨å»£ç™»è¨˜</a> ${b.rewardUrl ? `<a href="${b.rewardUrl}" target="_blank" style="color:var(--text-muted);">æ›é ˜çè³</a>` : ''}</div></div>`; });
    }
    function renderMissions() {
        const container = document.getElementById('missions-container'); if(!container) return; container.innerHTML = '';
        (state.missions || []).forEach(m => {
            let spent = 0; const start = m.start ? new Date(m.start) : new Date(0); const end = m.end ? new Date(m.end) : new Date(8640000000000000); end.setHours(23, 59, 59);
            (state.transactions || []).forEach(tx => { const d = new Date(tx.date); if (tx.type === 'expense' && m.cardIds && m.cardIds.includes(tx.cardId?.toString()) && d >= start && d <= end) spent += (Number(tx.amount)||0); });
            (state.trades || []).forEach(t => { const d = new Date(t.date); if (m.cardIds && m.cardIds.includes(t.cardId?.toString()) && t.status !== 'cut' && d >= start && d <= end) spent += ((Number(t.cost)||0) * (Number(t.qty)||1)); });
            const pct = Math.min((spent / m.target) * 100, 100); const isCompleted = spent >= m.target;
            container.innerHTML += `<div class="recur-item ${isCompleted ? 'completed' : ''}" style="margin-top:10px; position:relative;"><button class="btn-text" style="position:absolute; top:5px; right:5px; color:var(--danger);" onclick="deleteMission(${m.id})">&times;</button><div style="font-weight:bold; margin-bottom:5px;">â³ ${m.name}</div><div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:5px;">ç›®æ¨™: $${spent.toLocaleString()} / $${m.target.toLocaleString()}</div><div class="progress-bar" style="background:rgba(255,255,255,0.1);"><div class="progress-fill" style="width:${pct}%; background:${isCompleted?'var(--primary)':'#f39c12'}"></div></div></div>`;
        });
    }

    // --- åœ–è¡¨ ---
    function renderCharts() {
        const elCards = document.getElementById('chart-cards'); const elDaily = document.getElementById('chart-daily');
        if(!elCards || !elDaily) return;
        const style = getComputedStyle(document.body); const textColor = style.getPropertyValue('--chart-text').trim();
        const colors = ['#00d26a', '#4facfe', '#ff6b6b', '#fca5a5', '#ffd93d', '#a855f7'];
        const m = document.getElementById('analysis-month').value; if(!m) return;
        
        let txs = (state.transactions || []).filter(tx => tx.date && tx.date.startsWith(m) && tx.type === 'expense');
        let tradeTxs = (state.trades || []).filter(t => t.date && t.date.startsWith(m) && t.status !== 'cut');
        const cardTotals = {}; state.cards.forEach(c => cardTotals[c.name] = 0); 
        txs.forEach(tx => { const card = state.cards.find(c => c.id == tx.cardId); if(card) cardTotals[card.name] += (Number(tx.amount)||0); });
        tradeTxs.forEach(t => { const card = state.cards.find(c => c.id == t.cardId); if(card) cardTotals[card.name] += ((Number(t.cost)||0)*(Number(t.qty)||1)); });
        
        const pieL = Object.keys(cardTotals).filter(k => cardTotals[k] > 0); const pieD = pieL.map(k => cardTotals[k]);
        const dateParts = m.split('-'); if(dateParts.length < 2) return;
        const days = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]), 0).getDate();
        const daily = new Array(days).fill(0);
        
        txs.forEach(tx => { const dIdx = parseInt(tx.date.slice(8, 10)) - 1; if(!isNaN(dIdx) && dIdx >= 0 && dIdx < days) daily[dIdx] += (Number(tx.amount)||0); });
        tradeTxs.forEach(t => { const dIdx = parseInt(t.date.slice(8, 10)) - 1; if(!isNaN(dIdx) && dIdx >= 0 && dIdx < days) daily[dIdx] += ((Number(t.cost)||0)*(Number(t.qty)||1)); });
        const barL = Array.from({length: days}, (_, i) => (i + 1).toString());

        if(pieChart) pieChart.destroy(); if(barChart) barChart.destroy();
        pieChart = new Chart(elCards.getContext('2d'), { type: 'doughnut', data: { labels: pieL, datasets: [{ data: pieD, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: textColor } } } } });
        barChart = new Chart(elDaily.getContext('2d'), { type: 'bar', data: { labels: barL, datasets: [{ label: 'æ”¯å‡º', data: daily, backgroundColor: '#ff4d4d', borderRadius: 3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid: { display: false } }, y: { ticks: { color: textColor }, grid: { color: '#333' } } }, plugins: { legend: { display: false } } } });
    }

    // --- è¦–çª—åŠæ“ä½œç®¡ç† ---
    function openModal(type) {
        const m = document.getElementById('modal-'+type); if(!m) return; m.classList.add('active');
        if(type==='transaction') { document.getElementById('tx-form').reset(); document.getElementById('tx-id').value=''; setTxType('expense'); setDefaultTime(); }
        else if(type==='trade' && !document.getElementById('trade-id').value) { document.getElementById('trade-form').reset(); document.getElementById('trade-id').value=''; document.getElementById('trade-source-custom').style.display='none'; document.getElementById('trade-shop-custom').style.display='none'; document.querySelectorAll('#modal-trade .grid-btn.selected').forEach(b=>b.classList.remove('selected')); setDefaultTime(); updateFormOptions(); }
        else if(type==='category') renderCategories();
        else if(type==='recur-mission') renderRecurList();
        else if(type==='welcome') renderWelcomeList();
        else if(type==='subs') renderSubsList();
        else if(type==='bank-info') renderBankList();
    }
    
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); const tid = document.getElementById('trade-id'); if(tid) tid.value = ''; }
    function openMenuTarget(t) { closeModals(); setTimeout(()=>openModal(t), 50); }

    function setTxType(t) {
        const txType = document.getElementById('tx-type'); if(txType) txType.value = t;
        document.querySelectorAll('.type-option').forEach(e=>e.classList.remove('active','expense','income','repayment'));
        const activeBtn = document.getElementById('type-'+t); if(activeBtn) activeBtn.classList.add('active', t);
        const catS = document.getElementById('tx-category'); 
        if(catS) { catS.innerHTML=''; const safeCats = (state.categories && state.categories[t]) ? state.categories[t] : DEFAULT_CATEGORIES[t]; safeCats.forEach(c=>catS.add(new Option(c,c))); }
        const groupCard = document.getElementById('group-card'); if(groupCard) groupCard.style.display = t==='income'?'none':'block';
        updateCardHint();
    }

    function switchCatType(t) {
        currentCatEditType = t;
        document.getElementById('cat-type-expense').classList.remove('active', 'expense');
        document.getElementById('cat-type-income').classList.remove('active', 'income');
        document.getElementById('cat-type-'+t).classList.add('active', t);
        renderCategories();
    }

    function addCategory(e) {
        e.preventDefault(); const v = document.getElementById('new-category-name').value.trim();
        if(v && state.categories && state.categories[currentCatEditType] && !state.categories[currentCatEditType].includes(v)) {
            state.categories[currentCatEditType].push(v); saveData(); renderCategories(); document.getElementById('new-category-name').value = '';
            if(document.getElementById('tx-type').value === currentCatEditType) setTxType(currentCatEditType);
        }
    }
    
    function deleteCategory(type, idx) { if(state.categories && state.categories[type]) { state.categories[type].splice(idx, 1); saveData(); renderCategories(); if(document.getElementById('tx-type').value === type) setTxType(type); } }

    function updateCardHint() {
        const select = document.getElementById('tx-card'); const hintBox = document.getElementById('card-hint'); const txType = document.getElementById('tx-type');
        if(!select || !hintBox || !txType) return;
        const c = state.cards.find(x=>x.id==select.value);
        if(c && txType.value === 'expense') { hintBox.style.display = 'block'; const r = c.percent !== undefined ? c.percent : (c.rate || 0); hintBox.innerHTML = `å›è´ˆ: ${r}%`; } 
        else { hintBox.style.display = 'none'; }
    }
    
    function updateFormOptions() {
        const s = document.getElementById('tx-card'); if(s) { s.innerHTML=''; state.cards.forEach(c => s.add(new Option(c.name, c.id))); }
        const ts = document.getElementById('trade-card'); if(ts) { ts.innerHTML='<option value="">ç„¡ä½¿ç”¨ä¿¡ç”¨å¡</option>'; state.cards.forEach(c => ts.add(new Option(c.name, c.id))); }
        const ws = document.getElementById('welcome-card'); if(ws) { ws.innerHTML=''; state.cards.forEach(c => ws.add(new Option(c.name, c.id))); }
        const rs = document.getElementById('recur-card'); if(rs) { rs.innerHTML=''; state.cards.forEach(c => rs.add(new Option(c.name, c.id))); }
        const subS = document.getElementById('sub-card'); if(subS) { subS.innerHTML=''; state.cards.forEach(c => subS.add(new Option(c.name, c.id))); }
        
        const missionCards = document.getElementById('mission-cards'); 
        if(missionCards) {
            missionCards.innerHTML='';
            state.cards.forEach(c => {
                const div = document.createElement('div'); div.className = 'checkbox-item';
                div.innerHTML = `<input type="checkbox" name="m-card" value="${c.id}" id="m-card-${c.id}"><label style="margin:0; padding-left:8px; width:100%; cursor:pointer;" for="m-card-${c.id}">${c.name}</label>`;
                missionCards.appendChild(div);
            });
        }
        updateCardHint();
    }

    function switchTab(name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const tabBtns = document.querySelectorAll('.tab');
        if(name==='transactions' && tabBtns[0]) { tabBtns[0].classList.add('active'); document.getElementById('tab-transactions').classList.add('active'); }
        else if(name==='cards' && tabBtns[1]) { tabBtns[1].classList.add('active'); document.getElementById('tab-cards').classList.add('active'); }
        else if(name==='trading' && tabBtns[2]) { tabBtns[2].classList.add('active'); document.getElementById('tab-trading').classList.add('active'); renderTrading(); }
        else if(name==='analysis' && tabBtns[3]) { tabBtns[3].classList.add('active'); document.getElementById('tab-analysis').classList.add('active'); renderCharts(); }
    }

    // --- è³‡æ–™å¯«å…¥æ“ä½œ ---
    function addTransaction(e) {
        e.preventDefault(); const idStr = document.getElementById('tx-id').value;
        const tx = { id: idStr ? parseFloat(idStr) : Date.now(), type: document.getElementById('tx-type').value, amount: parseFloat(document.getElementById('tx-amount').value), category: document.getElementById('tx-category').value, cardId: document.getElementById('tx-card') ? document.getElementById('tx-card').value : null, desc: document.getElementById('tx-desc').value, date: document.getElementById('tx-date').value };
        if(idStr) { const idx = state.transactions.findIndex(t=>t.id==tx.id); if(idx!==-1) state.transactions[idx] = tx; } 
        else { state.transactions.unshift(tx); if(state.settings && state.settings.tgAutoSend) sendTelegramTx(tx); }
        saveData(); render(); closeModals();
    }
    function editTransaction(id) {
        const tx = state.transactions.find(t=>t.id==id); if(!tx) return; openModal('transaction'); document.getElementById('tx-id').value=tx.id; setTxType(tx.type || 'expense');
        document.getElementById('tx-amount').value=tx.amount; document.getElementById('tx-desc').value=tx.desc; document.getElementById('tx-date').value=tx.date;
        if(tx.cardId && document.getElementById('tx-card')) document.getElementById('tx-card').value=tx.cardId;
        const title = document.getElementById('tx-modal-title'); if(title) title.innerText="ç·¨è¼¯ç´€éŒ„";
    }
    function deleteTransaction(id) { if(confirm('ç¢ºå®šåˆªé™¤ç´€éŒ„?')) { state.transactions=state.transactions.filter(t=>t.id!==id); saveData(); render(); } }
    
    function addCard(e) { e.preventDefault(); state.cards.push({ id: Date.now(), name: document.getElementById('card-name').value, percent: parseFloat(document.getElementById('card-percent').value)||0, cap: parseFloat(document.getElementById('card-cap').value)||0, note: document.getElementById('card-note').value }); saveData(); render(); closeModals(); }
    function deleteCard(id) { if(confirm('ç¢ºå®šåˆªé™¤å¡ç‰‡?')) { state.cards=state.cards.filter(c=>c.id!==id); saveData(); render(); } }
    
    // Trade Logic
    function selectTradeOption(type, val, el) {
        const input = document.getElementById('trade-'+type); if(input) input.value=val;
        const grid = el.parentElement; if(grid) { Array.from(grid.children).forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); }
        if(type==='model' || type==='cap') { const m = document.getElementById('trade-model').value; const c = document.getElementById('trade-cap').value; if(m && c && IPHONE_PRICES[m] && IPHONE_PRICES[m][c]) { const costInp = document.getElementById('trade-cost'); if(costInp) costInp.value = IPHONE_PRICES[m][c]; } }
    }
    function toggleCustomInput(type) { const sel = document.getElementById('trade-'+type); const inp = document.getElementById('trade-'+type+'-custom'); if(sel && inp) { if(sel.value === 'other') { inp.style.display = 'block'; inp.required = true; } else { inp.style.display = 'none'; inp.required = false; } } }

    function addTrade(e) {
        e.preventDefault();
        try {
            const idStr = document.getElementById('trade-id').value; const cost = parseFloat(document.getElementById('trade-cost').value) || 0; const price = parseFloat(document.getElementById('trade-price').value) || 0; const qty = parseInt(document.getElementById('trade-qty').value) || 1; const cid = document.getElementById('trade-card') ? document.getElementById('trade-card').value : '';
            let source = document.getElementById('trade-source').value; if(source === 'other') source = document.getElementById('trade-source-custom').value;
            let shop = document.getElementById('trade-shop').value; if(shop === 'other') shop = document.getElementById('trade-shop-custom').value;
            const tData = { source, shop, oid: document.getElementById('trade-oid').value || '', model: document.getElementById('trade-model').value, cap: document.getElementById('trade-cap').value, color: document.getElementById('trade-color').value, status: document.getElementById('trade-status').value, condition: document.getElementById('trade-condition').value, cost, price, qty, profit: (price-cost)*qty, cardId: cid, date: document.getElementById('trade-date').value };
            if (idStr) { tData.id = parseFloat(idStr); const idx = state.trades.findIndex(t => t.id === tData.id); if (idx !== -1) state.trades[idx] = tData; } 
            else { tData.id = Date.now(); state.trades.unshift(tData); if(state.settings.tgAutoSend) sendTelegramTradeAlert(tData); }
            saveData(); render(); closeModals(); showToast('âœ… äº¤æ˜“å·²å„²å­˜');
        } catch(err) { alert("å„²å­˜å¤±æ•—: " + err.message); }
    }
    function cloneTrade(id) { editTrade(id); const tid = document.getElementById('trade-id'); if(tid) tid.value = ''; const toid = document.getElementById('trade-oid'); if(toid) toid.value = ''; setDefaultTime(); showToast('ğŸ“‹ å·²è¤‡è£½ï¼è«‹ä¿®æ”¹å¾ŒæŒ‰å„²å­˜'); }
    function editTrade(id) {
        const t = state.trades.find(x => x.id === id); if (!t) return; openModal('trade'); document.getElementById('trade-id').value = t.id;
        const srcS = document.getElementById('trade-source'); if(srcS) { if([...srcS.options].some(o=>o.value===t.source)) { srcS.value=t.source; document.getElementById('trade-source-custom').style.display='none'; } else { srcS.value='other'; document.getElementById('trade-source-custom').style.display='block'; document.getElementById('trade-source-custom').value=t.source; } }
        const shpS = document.getElementById('trade-shop'); if(shpS) { if([...shpS.options].some(o=>o.value===t.shop) || !t.shop) { shpS.value=t.shop||""; document.getElementById('trade-shop-custom').style.display='none'; } else { shpS.value='other'; document.getElementById('trade-shop-custom').style.display='block'; document.getElementById('trade-shop-custom').value=t.shop; } }
        if(document.getElementById('trade-oid')) document.getElementById('trade-oid').value = t.oid || ""; if(document.getElementById('trade-cost')) document.getElementById('trade-cost').value = t.cost; if(document.getElementById('trade-price')) document.getElementById('trade-price').value = t.price; if(document.getElementById('trade-qty')) document.getElementById('trade-qty').value = t.qty; if(document.getElementById('trade-card')) document.getElementById('trade-card').value = t.cardId || ""; if(document.getElementById('trade-date') && t.date) document.getElementById('trade-date').value = t.date.slice(0,16);
        ['model', 'cap', 'color', 'status', 'condition'].forEach(type => { const val = t[type]; const input = document.getElementById('trade-'+type); if(input) { input.value = val; const grid = input.parentElement.querySelector('.btn-grid') || input.parentElement.parentElement.querySelector('.btn-grid'); if(grid) { Array.from(grid.children).forEach(b => { b.classList.remove('selected'); if(b.innerText.includes(val) || b.innerText===val) b.classList.add('selected'); }); } } });
    }
    function deleteTrade(id) { if(confirm('åˆªé™¤äº¤æ˜“?')) { state.trades = state.trades.filter(t=>t.id!==id); saveData(); render(); } }

    function addMission(e) { e.preventDefault(); const name = document.getElementById('mission-name').value; const target = parseFloat(document.getElementById('mission-target').value); const start = document.getElementById('mission-start').value; const end = document.getElementById('mission-end').value; const checkboxes = document.querySelectorAll('input[name="m-card"]:checked'); const cardIds = Array.from(checkboxes).map(cb => cb.value); if (cardIds.length === 0) { alert('è«‹è‡³å°‘é¸æ“‡ä¸€å¼µä¿¡ç”¨å¡ï¼'); return; } state.missions.push({ id: Date.now(), name, target, start, end, cardIds }); saveData(); renderMissions(); closeModals(); e.target.reset(); }
    function deleteMission(id) { if(confirm('åˆªé™¤ä»»å‹™?')) { state.missions=state.missions.filter(m=>m.id!==id); saveData(); renderMissions(); } }
    function addRecurMission(e) { e.preventDefault(); state.recurringMissions.push({id:Date.now(), name:document.getElementById('recur-name').value, target:parseFloat(document.getElementById('recur-target').value), cardId:document.getElementById('recur-card').value, resetDay:parseInt(document.getElementById('recur-reset-day').value)}); saveData(); renderRecurList(); e.target.reset(); }
    function deleteRecurMission(id) { if(confirm('åˆªé™¤?')) { state.recurringMissions=state.recurringMissions.filter(m=>m.id!==id); saveData(); renderRecurList(); } }
    function addWelcome(e) { e.preventDefault(); state.welcomeOffers.push({id:Date.now(), name:document.getElementById('welcome-name').value, cardId:document.getElementById('welcome-card').value, target:parseFloat(document.getElementById('welcome-target').value), deadline:document.getElementById('welcome-deadline').value, start:document.getElementById('welcome-start').value}); saveData(); renderWelcomeList(); e.target.reset(); }
    function deleteWelcome(id) { if(confirm('åˆªé™¤?')) { state.welcomeOffers=state.welcomeOffers.filter(w=>w.id!==id); saveData(); renderWelcomeList(); } }
    function addSubscription(e) { e.preventDefault(); state.subscriptions.push({id:Date.now(), name:document.getElementById('sub-name').value, amount:parseFloat(document.getElementById('sub-amount').value), cardId:document.getElementById('sub-card').value}); saveData(); renderSubsList(); e.target.reset(); }
    function deleteSub(id) { if(confirm('åˆªé™¤?')) { state.subscriptions=state.subscriptions.filter(s=>s.id!==id); saveData(); renderSubsList(); } }

    function getCardSpending(cardId) {
        const nowMonth = new Date().toISOString().slice(0, 7); let total = 0;
        (state.transactions || []).forEach(tx => { if(tx.date && tx.date.startsWith(nowMonth) && tx.cardId == cardId && tx.type === 'expense') total += (Number(tx.amount) || 0); });
        (state.trades || []).forEach(t => { if(t.date && t.date.startsWith(nowMonth) && t.cardId == cardId && t.status !== 'cut') total += ((Number(t.cost) || 0) * (Number(t.qty) || 1)); });
        return total;
    }

    // --- TG Notifications ---
    function saveTGSettings() { state.settings.tgToken = document.getElementById('tg-token').value; state.settings.tgChatId = document.getElementById('tg-chatid').value; state.settings.tgAutoSend = document.getElementById('setting-tg-auto').checked; saveData(); showToast('âœ… è¨­å®šå·²å„²å­˜'); }
    async function sendTGMessage(t, cid, msg) { if (!t || !cid) return; try { await fetch(`https://api.telegram.org/bot${t}/sendMessage`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({chat_id:cid, text:msg, parse_mode:'Markdown'}) }); } catch(e) { console.error(e); } }
    function testTG() { sendTGMessage(state.settings.tgToken, state.settings.tgChatId, 'ğŸ”” *å›è´ˆå“¥æ¸¬è©¦*\né€™æ˜¯ä¸€æ¢æ¸¬è©¦è¨Šæ¯ï¼'); showToast('ç™¼é€è«‹æ±‚å·²é€å‡º'); }

    function sendTelegramTradeAlert(t) {
        if(!state.settings.tgToken || !state.settings.tgChatId) return;
        let cText = "ç„¡ä½¿ç”¨ä¿¡ç”¨å¡", cLimit = "";
        if (t.cardId) {
            const card = state.cards.find(c => c.id == t.cardId);
            if (card) {
                cText = card.name; const spent = getCardSpending(card.id);
                cLimit = `\nğŸ“Š *æœ¬æœˆç´¯ç©*: $${spent.toLocaleString()}`;
                if (card.cap > 0) { cLimit += ` / $${card.cap.toLocaleString()} (${Math.round((spent/card.cap)*100)}%)`; if (spent >= card.cap) cLimit += `\nâš ï¸ *è­¦å‘Šï¼šå·²çˆ†é¡ï¼* ğŸš¨`; }
            }
        }
        const mStr = t.model === 'Pro Max' ? 'å¤§' : (t.model === 'Pro' ? 'ç´°' : t.model);
        const cStr = t.condition === 'opened' ? 'é–‹å°' : 'åŸå°';
        let msg = `ğŸ“± *æ–°ç‚’è³£ç´€éŒ„*\nğŸ›’ ä¾†æº: ${t.source}${t.oid?` (å–®è™Ÿ:${t.oid})`:''}\nğŸ“¦ è¦æ ¼: ${cStr}${mStr}${t.color}${t.cap} x${t.qty}\nğŸ’° ç¸½æˆæœ¬: $${(t.cost * t.qty).toLocaleString()}\n`;
        if (t.status === 'sold') msg += `ğŸ¤ å›æ”¶: ${t.shop} (è³£$${t.price})\nğŸ“ˆ åˆ©æ½¤: $${t.profit.toLocaleString()}\n`;
        else msg += `ğŸ“Œ ç‹€æ…‹: ${{'pending':'å·²è¨‚æœªå–','stock':'ç¾è²¨åœ¨æ‰‹'}[t.status]||t.status}\n`;
        msg += `ğŸ’³ å¡ç‰‡: ${cText}${cLimit}`;
        sendTGMessage(state.settings.tgToken, state.settings.tgChatId, msg);
    }
    
    function sendTelegramTx(tx) {
        if(!state.settings.tgToken || !state.settings.tgChatId) return;
        const card = state.cards.find(c => c.id == tx.cardId);
        const cardName = card ? card.name : 'N/A';
        const dateStr = tx.date ? tx.date.replace('T', ' ') : '';
        let msg = `ğŸ”” *æ–°å¢è¨˜è³¬*\nğŸ’° *é‡‘é¡*: HKD $${Number(tx.amount).toLocaleString()}\nğŸ’³ *å¡ç‰‡*: ${cardName}\nğŸ“ *æè¿°*: ${tx.desc}\nğŸ“‚ *é¡åˆ¥*: ${tx.category}\nğŸ“… *æ™‚é–“*: ${dateStr}`;
        sendTGMessage(state.settings.tgToken, state.settings.tgChatId, msg);
    }
    
    function sendTradeReport() {
        if (!state.settings.tgToken) { alert('è«‹å…ˆè¨­å®š TG Token'); return; }
        const filterMonth = document.getElementById('analysis-month') ? document.getElementById('analysis-month').value : new Date().toISOString().slice(0, 7);
        const sold = (state.trades || []).filter(t => t.status === 'sold' && t.date && t.date.startsWith(filterMonth));
        if (sold.length === 0) { alert('æœ¬æœˆæš«ç„¡å·²è³£å‡ºçš„äº¤æ˜“'); return; }
        sold.sort((a,b) => new Date(b.date) - new Date(a.date));
        const rep = {}; let tot = 0;
        sold.forEach(t => { const d = t.date.slice(0, 10); if(!rep[d]) rep[d] = {}; const sh = t.shop || 'å…¶ä»–'; if(!rep[d][sh]) rep[d][sh] = []; rep[d][sh].push(t); tot += (Number(t.profit)||0); });
        let msg = `ğŸ“Š *ç‚’è³£å ±å‘Š (${filterMonth})*\nğŸ’° ç¸½åˆ©æ½¤: $${tot.toLocaleString()}\n------------------\n`;
        for (const [date, shops] of Object.entries(rep)) {
            msg += `ğŸ“… *${date}*\n`;
            for (const [shop, items] of Object.entries(shops)) {
                msg += `ğŸ¢ ${shop}\n`; const sum = {};
                items.forEach(t => {
                    const key = `${t.condition==='opened'?'é–‹å°':'åŸå°'}${t.model==='Pro Max'?'å¤§':'ç´°'}${t.color}${t.cap}`;
                    if(!sum[key]) sum[key] = {q:0, p:0}; sum[key].q += (Number(t.qty)||1); sum[key].p += (Number(t.profit)||0);
                });
                for (const [k, v] of Object.entries(sum)) msg += `- ${k}: ${v.q} (è³º$${v.p})\n`;
            } msg += `\n`;
        }
        sendTGMessage(state.settings.tgToken, state.settings.tgChatId, msg); showToast('âœ… å ±å‘Šå·²ç™¼é€');
    }

    // --- Utility / UI Helpers ---
    function toggleTheme() { const t = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'; localStorage.setItem(THEME_KEY, t); applyTheme(t); }
    function applyTheme(t) { document.documentElement.setAttribute('data-theme', t); const btn = document.getElementById('btn-theme'); if(btn) btn.innerText = t==='dark'?'â˜€ï¸':'ğŸŒ™'; if (document.getElementById('tab-analysis').classList.contains('active')) renderCharts(); }
    function importPresetCards() { if(!confirm('ç¢ºå®šåŒ¯å…¥æœ€æ–°ç¥å¡?')) return; PRESET_CARDS.forEach(p=> { if(p.cap>0 && !state.cards.find(c=>c.name===p.name)) state.cards.push({...p, id: Date.now()+Math.random()}) }); saveData(); render(); showToast('âœ… å·²åŒ¯å…¥'); }
    function exportData(type) { const str = type==='json' ? JSON.stringify(state) : 'Date,Desc,Amount\n'+state.transactions.map(t=>`${t.date},${t.desc},${t.amount}`).join('\n'); const blob = new Blob([str], {type: type==='json'?'application/json':'text/csv'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='backup.'+type; a.click(); }
    function triggerImport() { const f = document.getElementById('file-input'); if(f) f.click(); }
    function importData(input) { const reader = new FileReader(); reader.onload = e => { try { state = JSON.parse(e.target.result); saveData(); location.reload(); } catch(err) { alert("é‚„åŸå¤±æ•—ï¼Œæª”æ¡ˆæå£ï¼"); } }; reader.readAsText(input.files[0]); }
    function rescueData() { exportData('json'); showToast('ğŸ’¾ è³‡æ–™å·²ä¸‹è¼‰'); }
    function resetData() { if(confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ç¢ºå®šå—ï¼Ÿ')) { localStorage.removeItem(DB_KEY); location.reload(); } }
    
    // UI Helpers
    function setDefaultTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const dStr = now.toISOString().slice(0,16);
        if(document.getElementById('tx-date')) document.getElementById('tx-date').value = dStr;
        if(document.getElementById('trade-date')) document.getElementById('trade-date').value = dStr;
    }
    
    function handleCurrencyChange() {
        const c = document.getElementById('tx-currency').value;
        if(document.getElementById('fx-rate-container')) document.getElementById('fx-rate-container').style.display = c === 'HKD' ? 'none' : 'block';
        if(document.getElementById('fx-amount-container')) document.getElementById('fx-amount-container').style.display = c === 'HKD' ? 'none' : 'block';
    }
    
    function calcHkdAmount() {
        const amt = parseFloat(document.getElementById('tx-fx-amount').value) || 0;
        const rate = parseFloat(document.getElementById('tx-fx-rate').value) || 0;
        if(amt && rate && document.getElementById('tx-amount')) document.getElementById('tx-amount').value = (amt * rate).toFixed(2);
    }
    
    function calcSplit() {
        const t = parseFloat(document.getElementById('split-total').value) || 0;
        const dis = parseFloat(document.getElementById('split-discount').value) || 0;
        const svc = document.getElementById('split-service') ? document.getElementById('split-service').checked : false;
        const p = parseInt(document.getElementById('split-people').value) || 1;
        let final = t;
        if(svc) final *= 1.1;
        if(dis) final *= (1 - dis / 100);
        if(document.getElementById('split-result')) document.getElementById('split-result').innerText = '$' + (final / p).toFixed(2);
    }
    
    function adjustPeople(d) {
        const i = document.getElementById('split-people');
        if(i) { i.value = Math.max(1, parseInt(i.value) + d); calcSplit(); }
    }
    
    function applySplit() {
        if(document.getElementById('split-result') && document.getElementById('tx-amount')) {
            document.getElementById('tx-amount').value = parseFloat(document.getElementById('split-result').innerText.replace('$', ''));
            closeModals();
        }
    }
    
    function adjustTradeQty(d) { 
        const i = document.getElementById('trade-qty'); 
        if(i) i.value = Math.max(1, parseInt(i.value) + d); 
    }

    // Start App
    init();
</script>
</body>
</html>
